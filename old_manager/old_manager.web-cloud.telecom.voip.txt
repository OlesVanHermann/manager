# CAHIER DES CHARGES - VoIP Time Condition
## old_manager_web-cloud.telecom.voip

---

# 1. RÉSUMÉ EXÉCUTIF

| Élément | Valeur |
|---------|--------|
| **Archive source** | `old_manager_web-cloud_telecom_voip.tar` |
| **Framework legacy** | AngularJS |
| **Périmètre fonctionnel** | Gestion des plages horaires (Time Conditions) pour la téléphonie VoIP |
| **Fonctionnalités** | Configuration créneaux horaires, redirections appels, calendrier visuel |
| **Utilisateurs cibles** | Clients OVHcloud avec services Téléphonie (SIP, EasyHunting, OvhPabx) |
| **Fichiers analysés** | 33 JS, 6 HTML, 33 JSON (traductions) |

---

# 2. ARCHITECTURE

## 2.1 Arborescence des fichiers

```
packages/manager/apps/telecom/src/
├── components/
│   ├── notification/
│   │   ├── notification.component.js
│   │   ├── notification.service.js
│   │   ├── notification-list.html
│   │   └── translations/ (8 langues)
│   │
│   ├── telecom/
│   │   ├── telecom-mediator.service.js
│   │   └── telephony/
│   │       ├── mediator.service.js
│   │       │
│   │       ├── service/
│   │       │   ├── choice/
│   │       │   │   ├── choice.controller.js
│   │       │   │   ├── choice.directive.js
│   │       │   │   ├── choice.html
│   │       │   │   └── translations/
│   │       │   │
│   │       │   └── time-condition-configuration/
│   │       │       └── time-condition-configuration.service.js
│   │       │
│   │       └── timeCondition/
│   │           ├── time-condition.service.js
│   │           ├── time-condition.factory.js
│   │           ├── time-condition.constant.js
│   │           ├── time-condition.less
│   │           │
│   │           ├── calendar/
│   │           │   ├── calendar.directive.js
│   │           │   ├── calendar.controller.js
│   │           │   └── calendar.html
│   │           │
│   │           ├── condition/
│   │           │   ├── condition.factory.js
│   │           │   ├── edit/
│   │           │   │   ├── edit.controller.js
│   │           │   │   └── edit.html
│   │           │   └── translations/
│   │           │
│   │           └── slot/
│   │               ├── slot.factory.js
│   │               ├── slot.component.js
│   │               ├── slot.controller.js
│   │               ├── slot.html
│   │               ├── edit/
│   │               │   ├── edit.controller.js
│   │               │   └── edit.html
│   │               └── translations/
│   │
│   ├── popover/
│   ├── moment/
│   └── ng-pluralize/
```

## 2.2 Patterns architecturaux

| Pattern | Usage |
|---------|-------|
| Factory Pattern | `VoipTimeCondition`, `VoipTimeConditionCondition`, `VoipTimeConditionSlot` |
| Service Layer | `voipTimeCondition`, `TelephonyMediator` |
| Directive | `voip-time-condition-calendar`, `voip-service-choice` |
| Controller + Template | Modèle AngularJS classique |
| Resource Abstraction | `OvhApiTelephony.*.v6()` pour les appels API |

## 2.3 Dépendances

| Dépendance | Type | Usage |
|------------|------|-------|
| lodash | NPM | Utilitaires (filter, map, find, get, etc.) |
| moment | NPM | Manipulation dates/heures |
| angular | Framework | Base AngularJS |
| ui.calendar | Angular Module | Calendrier FullCalendar |
| OvhApiTelephony | OVH Module | Abstraction API Telephony |
| iceberg | OVH Module | Pagination Iceberg |
| TucToast | OVH Component | Notifications toast |
| coreConfig | OVH Service | Configuration (locale) |

---

# 3. PAGES & NAVIGATION

## 3.1 Composants de page

Ce module contient des composants réutilisables, pas des pages complètes.

| Composant | Rôle | Route parente |
|-----------|------|---------------|
| `voip-time-condition-calendar` | Calendrier visuel des conditions | `/telecom/{billingAccount}/line/{serviceName}/timeCondition` |
| `voip-time-condition-slot` | Affichage/édition d'un créneau | Intégré dans page timeCondition |
| `voip-service-choice` | Sélecteur de service | Modal/Popover |

## 3.2 Flux utilisateur

```
┌─────────────────────────────────────────────────────────────────┐
│                     PAGE TIME CONDITION                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  LÉGENDE DES CRÉNEAUX (slots)                             │  │
│  │  [Ouverture] [Créneau 1] [Créneau 2] [Créneau 3] [Fermeture]│
│  │   (vert)     (orange)    (bleu)      (violet)    (rouge)  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                 CALENDRIER SEMAINE                         │  │
│  │  ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┐             │  │
│  │  │ Lun │ Mar │ Mer │ Jeu │ Ven │ Sam │ Dim │             │  │
│  │  ├─────┼─────┼─────┼─────┼─────┼─────┼─────┤             │  │
│  │  │08:00│     │     │     │     │     │     │             │  │
│  │  │█████│     │     │     │     │     │     │             │  │
│  │  │12:00│     │     │     │     │     │     │             │  │
│  │  └─────┴─────┴─────┴─────┴─────┴─────┴─────┘             │  │
│  │  (Cliquer/glisser pour créer, cliquer pour éditer)        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

                            │
                            ▼ CLIC SUR CONDITION

┌─────────────────────────────────────────────────────────────────┐
│               POPOVER ÉDITION CONDITION                          │
├─────────────────────────────────────────────────────────────────┤
│  Jour: Lundi                                                     │
│  Répéter: [Sélection jours...] ──────────────────────────► page │
│  Rediriger vers: [Créneau 1 - Répondeur +33...] ─────────► page │
│  Plage horaire:                                                  │
│    De: [08:30]  à: [12:00]                                      │
│                                                                  │
│  [Modifier] [Supprimer] [Annuler]                               │
└─────────────────────────────────────────────────────────────────┘
```

---

# 4. COMPOSANTS UI

## 4.1 Composants OVH Design System (ODS)

| Composant ODS | Usage | Fichier |
|---------------|-------|---------|
| `oui-spinner` | Loading states | Multiples |
| `oui-button` | Actions (Modifier, Annuler...) | condition/edit.html |
| `oui-radio` | Sélection policy/type | condition/edit.html, slot/edit.html |
| `oui-checkbox` | Répétition jours | condition/edit.html |
| `oui-field` | Champ formulaire | slot/edit.html |
| `oui-input` | Champ texte | slot/edit.html |
| `oui-timepicker` | Sélection heure | condition/edit.html |
| `oui-message` | Alertes/warnings | notification-list.html |
| `oui-numeric` | Input numérique | notification-list.html |
| `oui-popover` | Info-bulles | slot.html |

## 4.2 Composants Manager spécifiques

| Composant | Props/Bindings | Comportement |
|-----------|----------------|--------------|
| `voip-time-condition-calendar` | `timeCondition`, `options` | Affiche calendrier FullCalendar, gère création/édition |
| `voip-time-condition-slot` | `slot`, `enableEdition`, `hasPopover`, `timeCondition` | Affiche créneau avec icône config |
| `voip-service-choice` | `onChoiceChanged`, `hideHeader`, `hideFooter` | Sélecteur service téléphonique |

## 4.3 Classes CSS

| Classe | Usage |
|--------|-------|
| `popover-pages`, `popover-page` | Navigation multi-pages dans popover |
| `section-group`, `section-item` | Groupement formulaires |
| `legend-color` + `.available`, `.slot1`, `.unavailable` | Couleurs créneaux |
| `form-control`, `form-control-static` | Bootstrap form |
| `btn btn-primary`, `btn btn-default` | Bootstrap buttons |
| `alert alert-danger`, `alert alert-info` | Alertes Bootstrap |

---

# 5. APIs & DONNÉES

## 5.1 Endpoints API - TimeCondition (SIP)

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/telephony/{billingAccount}/timeCondition/{serviceName}/options` | Récupérer options time condition |
| PUT | `/telephony/{billingAccount}/timeCondition/{serviceName}/options` | Sauvegarder options |
| GET | `/telephony/{billingAccount}/timeCondition/{serviceName}/condition` | Lister conditions (IDs) |
| GET | `/telephony/{billingAccount}/timeCondition/{serviceName}/condition/{id}` | Détail condition |
| POST | `/telephony/{billingAccount}/timeCondition/{serviceName}/condition` | Créer condition |
| PUT | `/telephony/{billingAccount}/timeCondition/{serviceName}/condition/{id}` | Modifier condition |
| DELETE | `/telephony/{billingAccount}/timeCondition/{serviceName}/condition/{id}` | Supprimer condition |

## 5.2 Endpoints API - EasyHunting

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/telephony/{billingAccount}/easyHunting/{serviceName}/timeConditions` | Récupérer time conditions |
| PUT | `/telephony/{billingAccount}/easyHunting/{serviceName}/timeConditions` | Sauvegarder |
| GET | `/telephony/{billingAccount}/easyHunting/{serviceName}/timeConditions/conditions` | Lister conditions |
| POST | `/telephony/{billingAccount}/easyHunting/{serviceName}/timeConditions/conditions` | Créer condition |
| PUT | `/telephony/{billingAccount}/easyHunting/{serviceName}/timeConditions/conditions/{conditionId}` | Modifier |
| DELETE | `/telephony/{billingAccount}/easyHunting/{serviceName}/timeConditions/conditions/{conditionId}` | Supprimer |

## 5.3 Endpoints API - OvhPabx

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/telephony/{billingAccount}/ovhPabx/{serviceName}/dialplan/{dialplanId}/extension/{extensionId}/conditionTime` | Lister conditions |
| POST | `/telephony/{billingAccount}/ovhPabx/{serviceName}/dialplan/{dialplanId}/extension/{extensionId}/conditionTime` | Créer |
| PUT | `/telephony/{billingAccount}/ovhPabx/{serviceName}/dialplan/{dialplanId}/extension/{extensionId}/conditionTime/{conditionId}` | Modifier |
| DELETE | `/telephony/{billingAccount}/ovhPabx/{serviceName}/dialplan/{dialplanId}/extension/{extensionId}/conditionTime/{conditionId}` | Supprimer |

## 5.4 Endpoints API - Généraux Telephony

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/telephony` | Liste billing accounts (Iceberg) |
| GET | `/telephony/{billingAccount}` | Détail groupe |
| GET | `/telephony/{billingAccount}/service` | Liste services (Iceberg) |
| GET | `/telephony/{billingAccount}/service/{serviceName}` | Détail service |
| GET | `/telephony/searchServices?axiom={axiom}` | Recherche service |
| GET | `/telephony.json` | Schema API |

## 5.5 Autres endpoints

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/sms` | Liste comptes SMS (notifications) |

## 5.6 Séquencement des appels

```
INITIALISATION TIME CONDITION
│
├─► 1. GET /.../options
│      → Récupère enable, timeout, slots configuration
│
├─► 2. GET /.../condition (query)
│      → Liste des IDs de conditions
│
└─► 3. GET /.../condition/{id} (getBatch, chunks de 50)
       → Détails de chaque condition (parallélisé)


SAUVEGARDE
│
├─► PUT /.../options
│      → Sauvegarde slots, enable, timeout
│
└─► Pour chaque condition modifiée ($q.allSettled):
       - state=TO_CREATE → POST /condition
       - state=TO_DELETE → DELETE /condition/{id}
       - state=OK (hasChange) → PUT /condition/{id}
```

## 5.7 Types de données

### VoipTimeCondition (Factory principale)

```typescript
interface VoipTimeCondition {
  billingAccount: string;
  serviceName: string;
  featureType: 'sip' | 'easyHunting' | 'ovhPabx';
  extensionId?: number;          // requis si ovhPabx
  dialplanId?: number;           // requis si ovhPabx
  
  enable: boolean;
  timeout?: number;              // sip uniquement (défaut: 45)
  
  slots: VoipTimeConditionSlot[];
  conditions: VoipTimeConditionCondition[];
  
  status: 'OK' | 'SAVING';
  inEdition: boolean;
  saveForEdition: object | null;
}
```

### VoipTimeConditionCondition

```typescript
interface VoipTimeConditionCondition {
  billingAccount: string;
  serviceName: string;
  featureType: 'sip' | 'easyHunting' | 'ovhPabx';
  
  conditionId: number | string;  // 'tmp_xxx' si non créée
  state: 'OK' | 'DRAFT' | 'TO_CREATE' | 'TO_DELETE';
  
  weekDay: 'monday' | 'tuesday' | 'wednesday' | 'thursday' | 'friday' | 'saturday' | 'sunday';
  timeFrom: string;              // Format 'HH:mm:ss'
  timeTo: string;                // Format 'HH:mm:ss'
  policy: 'available' | 'slot1' | 'slot2' | 'slot3';  // pas pour ovhPabx
  
  // Pour SIP (format différent API)
  hourBegin?: string;            // Format 'HHmm'
  hourEnd?: string;              // Format 'HHmm'
  day?: string;
}
```

### VoipTimeConditionSlot

```typescript
interface VoipTimeConditionSlot {
  serviceName: string;
  name: 'available' | 'unavailable' | 'slot1' | 'slot2' | 'slot3';
  type: 'number' | 'voicemail';
  number: string;                // Numéro format international ou serviceName OVH
  
  noConfig?: boolean;
  inEdition: boolean;
  saveForEdition: object | null;
  originalSave: object | null;
}
```

### Constantes

```typescript
const VOIP_TIME_CONDITION = {
  slotTypesCount: {
    sip: 3,
    easyHunting: 3,
    ovhPabx: 0
  }
};

const VOIP_TIME_CONDITION_DEFAULT_SLOTS = [
  { name: 'available', noConfig: true },
  { name: 'slot1', noConfig: true },
  { name: 'slot2', noConfig: true },
  { name: 'slot3', noConfig: true },
  { name: 'unavailable', noConfig: true }
];

const VOIP_TIMECONDITION_ORDERED_DAYS = [
  'monday', 'tuesday', 'wednesday', 'thursday', 
  'friday', 'saturday', 'sunday'
];
```

---

# 6. TRADUCTIONS (i18n)

## 6.1 Slots

| Clé | FR | EN |
|-----|----|----|
| `voip_time_condition_slots_type_slot1` | Créneau 1 | Slot 1 |
| `voip_time_condition_slots_type_slot2` | Créneau 2 | Slot 2 |
| `voip_time_condition_slots_type_slot3` | Créneau 3 | Slot 3 |
| `voip_time_condition_slots_type_available` | Horaires d'ouverture | Open hours |
| `voip_time_condition_slots_type_unavailable` | Horaires de fermeture | Closed hours |
| `voip_time_condition_slots_undefined` | Non configuré | Not configured |
| `voip_time_condition_slots_configure` | Configurer | Configure |
| `voip_time_condition_slots_redirect_type_voicemail` | Rediriger vers le répondeur : {{ number }} | Redirect to voicemail: {{ number }} |
| `voip_time_condition_slots_redirect_type_number` | Rediriger vers le numéro : {{ number }} | Redirect to number: {{ number }} |
| `voip_time_condition_slots_type_available_help` | Créneaux durant lesquels il est possible de vous joindre | Time slots during which it is possible to contact you |
| `voip_time_condition_slots_type_unavailable_help` | Créneaux durant lesquels il est impossible de vous joindre | Slots during which you cannot be reached |
| `voip_time_condition_slots_type_slot_help` | Créneaux supplémentaires avec redirection | Additional time slots with redirection |

## 6.2 Popover édition slot

| Clé | FR | EN |
|-----|----|----|
| `voip_time_condition_slots_redirect_popover_back_btn_title` | Retour | Back |
| `voip_time_condition_slots_redirect_popover_slot1_title` | Configuration du créneau 1 | Slot 1 configuration |
| `voip_time_condition_slots_redirect_popover_slot1_help` | Comportement à adopter pour les plages horaires utilisant le créneau 1 | Behaviour to be applied to time conditions using slot 1 |
| `voip_time_condition_slots_redirect_popover_unavailable_title` | Créneaux hors plages horaires | Slots outside time conditions |
| `voip_time_condition_slots_redirect_popover_unavailable_help` | Comportement par défaut en dehors des plages horaires | Default behaviour outside of time conditions |
| `voip_time_condition_slots_redirect_popover_unavailable_help_timeout` | Ce comportement sera déclenché après le délai de renvoi renseigné | This behaviour will be triggered after the forwarding time |
| `voip_time_condition_slots_redirect_popover_redirect_type` | Rediriger l'appel vers | Redirect call to |
| `voip_time_condition_slots_redirect_popover_redirect_type_voicemail` | Un répondeur | Voicemail |
| `voip_time_condition_slots_redirect_popover_redirect_type_voicemail_explain` | Renvoyer l'appel vers le répondeur d'une ligne (sans la faire sonner) | Forward call to voicemail (without ringing) |
| `voip_time_condition_slots_redirect_popover_redirect_type_number` | Un numéro externe | An external number |
| `voip_time_condition_slots_redirect_popover_redirect_type_number_explain` | Renvoyer l'appel vers un numéro externe (hors OVHcloud) | Forward call to external number (non-OVHcloud) |
| `voip_time_condition_slots_redirect_popover_redirect_type_number_ovh` | Une ligne ou un numéro OVHcloud | An OVHcloud line or number |
| `voip_time_condition_slots_redirect_popover_redirect_type_number_ovh_explain` | Renvoyer l'appel vers l'une de vos lignes OVHcloud | Forward call to one of your OVHcloud lines |
| `voip_time_condition_slots_redirect_popover_number_to_redirect` | Numéro vers lequel rediriger | Number to redirect to |
| `voip_time_condition_slots_redirect_popover_number_to_redirect_placeholder` | Numéro au format international (ex: +3312345678) | Number in international format (e.g. +441234567890) |
| `voip_time_condition_slots_redirect_popover_number_to_redirect_required` | Le numéro vers lequel rediriger est obligatoire | You must enter a redirect number |
| `voip_time_condition_slots_redirect_popover_number_to_redirect_format` | Le numéro doit être au format international | The number must be in international format |

## 6.3 Conditions

| Clé | FR | EN |
|-----|----|----|
| `voip_time_condition_condition_add_popover_title` | Ajouter une plage horaire | Add a time condition |
| `voip_time_condition_condition_edit_popover_title` | Modifier une plage horaire | Modify a time condition |
| `voip_time_condition_condition_popover_days` | Jour de la semaine | Day of the week |
| `voip_time_condition_condition_popover_days_monday` | Lundi | Monday |
| `voip_time_condition_condition_popover_days_tuesday` | Mardi | Tuesday |
| `voip_time_condition_condition_popover_days_wednesday` | Mercredi | Wednesday |
| `voip_time_condition_condition_popover_days_thursday` | Jeudi | Thursday |
| `voip_time_condition_condition_popover_days_friday` | Vendredi | Friday |
| `voip_time_condition_condition_popover_days_saturday` | Samedi | Saturday |
| `voip_time_condition_condition_popover_days_sunday` | Dimanche | Sunday |
| `voip_time_condition_condition_popover_repeater` | Répéter | Repeat |
| `voip_time_condition_condition_popover_days_repeat_monday` | Tous les lundis | Every Monday |
| `voip_time_condition_condition_popover_days_repeat_tuesday` | Tous les mardis | Every Tuesday |
| `voip_time_condition_condition_popover_days_repeat_wednesday` | Tous les mercredis | Every Wednesday |
| `voip_time_condition_condition_popover_days_repeat_thursday` | Tous les jeudis | Every Thursday |
| `voip_time_condition_condition_popover_days_repeat_friday` | Tous les vendredis | Every Friday |
| `voip_time_condition_condition_popover_days_repeat_saturday` | Tous les samedis | Every Saturday |
| `voip_time_condition_condition_popover_days_repeat_sunday` | Tous les dimanches | Every Sunday |
| `voip_time_condition_condition_popover_days_repeat_weekDays` | Seulement les jours de la semaine | Weekdays only |
| `voip_time_condition_condition_popover_days_repeat_weekendDays` | Seulement les week-ends | Weekends only |
| `voip_time_condition_condition_popover_days_repeat_weekDays_label` | Tous les jours de la semaine | Every day of the week |
| `voip_time_condition_condition_popover_days_repeat_weekendDays_label` | Tout le week-end | Both weekend days |
| `voip_time_condition_condition_popover_days_repeat_allDays_label` | Tous les jours | Every day |
| `voip_time_condition_condition_popover_policy` | Rediriger les appels vers | Redirect calls to |
| `voip_time_condition_condition_popover_time_slot` | Plage horaire | Time condition |
| `voip_time_condition_condition_popover_time_slot_from` | De | From |
| `voip_time_condition_condition_popover_time_slot_to` | à | to |
| `voip_time_condition_condition_popover_time_slot_overlap` | Cette plage horaire est en conflit avec une autre ! | This time condition conflicts with another |
| `voip_time_condition_condition_popover_delete` | Suppression | Deleting |
| `voip_time_condition_condition_popover_delete_confirm` | Êtes-vous certain de vouloir supprimer cette plage horaire ? | Are you sure you want to delete this time condition? |

## 6.4 Service Choice

| Clé | FR | EN |
|-----|----|----|
| `telephony_service_choice_title` | Choix du service | Service selection |
| `telephony_service_choice_filter_type_sip` | Lignes SIP | SIP lines |
| `telephony_service_choice_filter_type_plugAndFax` | Lignes SIP (plug&fax) | SIP lines (plug & fax) |
| `telephony_service_choice_filter_type_trunk` | Lignes Trunk | Trunk lines |
| `telephony_service_choice_filter_type_fax` | Fax | Fax |
| `telephony_service_choice_filter_type_number` | Numéro | Number |
| `telephony_service_choice_destination` | Choisissez un service | Choose a service |

## 6.5 Notifications

| Clé | FR | EN |
|-----|----|----|
| `components_notification_delete` | Supprimer | Delete |
| `components_notification_type` | Type | Type |
| `components_notification_loading` | Le chargement de vos alertes est en cours... | Loading your notifications... |
| `components_notification_noNotification` | Il n'y a aucune alerte enregistrée | There are no notifications |
| `components_notification_frequency` | Fréquence d'envoi | Send frequency |
| `components_notification_contact` | Contact à notifier | Contact to notify |
| `components_notification_account` | Compte | Account |
| `components_notification_add` | Ajouter une alerte | Add a notification |
| `components_notification_mail` | E-mail | Email address |
| `components_notification_sms` | SMS | SMS |
| `components_notification_once` | Une fois | Once |
| `components_notification_5m` | Toutes les 5 minutes | Every 5 minutes |
| `components_notification_1h` | Toutes les heures | Hourly |
| `components_notification_6h` | Toutes les 6 heures | Every 6 hours |
| `components_notification_allowIncident` | Notification des incidents | Incident notification |
| `components_notification_downThreshold` | Délai avant notification (en minutes) | Time before notification (in minutes) |
| `components_notification_true` | Oui | Yes |
| `components_notification_false` | Non | No |

## 6.6 Sidebar/Filtres

| Clé | FR | EN |
|-----|----|----|
| `telecom_sidebar_section_telephony_filter_number` | Numéro | Number |
| `telecom_sidebar_section_telephony_filter_line` | Ligne SIP | SIP line |
| `telecom_sidebar_section_telephony_filter_fax` | Fax | Fax |
| `telecom_sidebar_section_telephony_filter_plug_fax` | Plug & Fax | Plug & Fax |
| `telecom_sidebar_section_telephony_filter_trunk` | Ligne SIP Trunk | SIP Trunk line |

---

# 7. RÈGLES MÉTIER

## 7.1 Validations

| Règle | Description | Regex/Logique |
|-------|-------------|---------------|
| Numéro international | Format E.164 | `/^\+(?:[0-9]){6,14}[0-9]$/` |
| Chevauchement plages | Deux conditions même jour ne se chevauchent pas | Vérification `isBetween` moment.js |
| timeFrom < timeTo | Heure début avant heure fin (sauf minuit) | `isSameOrAfter` moment.js |
| Incrément 15 min | Heures par tranches de 15 minutes | `minuteInt % 15 === 0` |

## 7.2 Machine d'états des conditions

```
DRAFT ─────────────────► TO_CREATE ───────────► OK
  │                           │                  │
  │ (annulation)              │ (sauvegarde)     │ (modification)
  ▼                           ▼                  ▼
[Suppression locale]    [POST API]         [PUT API]
                              │                  │
                              └──────────────────┘
                                      │
                                      ▼
                                     OK
                                      │
                                      │ (suppression)
                                      ▼
                                 TO_DELETE
                                      │
                                      │ (sauvegarde)
                                      ▼
                               [DELETE API]
                                      │
                                      ▼
                            [Suppression locale]
```

## 7.3 Conversion horaire SIP

Le format SIP est différent (HHmm) et nécessite des conversions :

```javascript
// getSipTime: 'HH:mm:ss' → 'HHmm'
// Ex: '08:30:00' → '0830'
// Pour fin: '17:29:59' → '1730' (arrondi minute suivante)

// parseSipTime: 'HHmm' → 'HH:mm:ss'
// Ex: '0830' → '08:30:00'
// Avec modulo: '1730' → '17:29:59'
```

## 7.4 Permissions par feature type

| Feature Type | Slots disponibles | Policy configurable | Timeout configurable |
|--------------|-------------------|---------------------|---------------------|
| sip | 3 (slot1-3) | Oui | Oui (défaut 45s) |
| easyHunting | 3 (slot1-3) | Oui | Non |
| ovhPabx | 0 | Non | Non |

## 7.5 Fonctionnalité Répéter

Permet de dupliquer une condition sur plusieurs jours :

- Jours individuels (lundi, mardi, etc.)
- Raccourcis : "Tous les jours de la semaine", "Tout le week-end"
- La duplication vérifie les chevauchements avant création

## 7.6 Logique de groupement des conditions

Les conditions sont groupées pour affichage selon :

1. Même plage horaire (timeFrom + timeTo)
2. Mêmes jours

Affichage formaté : "Lu - Ve : de 08:30 à 12:00, de 14:00 à 18:00"

---

# 8. RECOMMANDATIONS MIGRATION

## 8.1 Stack technique recommandée

| Ancien | Nouveau |
|--------|---------|
| AngularJS | React 18+ |
| OvhApiTelephony | `@ovh-ux/manager-core-api` (v6.get, v6.post...) |
| ui-calendar (FullCalendar 3) | FullCalendar 6 React |
| Bootstrap 3 | Tailwind CSS + ODS React |
| $q.allSettled | Promise.allSettled native |
| moment.js | date-fns ou dayjs |

## 8.2 Mapping composants ODS

| Composant AngularJS | Équivalent ODS React |
|---------------------|---------------------|
| oui-spinner | `<OsdsSpinner />` |
| oui-button | `<OsdsButton />` |
| oui-radio | `<OsdsRadio />` |
| oui-checkbox | `<OsdsCheckbox />` |
| oui-field | `<OsdsFormField />` |
| oui-input | `<OsdsInput />` |
| oui-timepicker | À implémenter ou lib externe |
| Popover custom | `<OsdsPopover />` ou Radix UI |

## 8.3 Points d'attention

1. **FullCalendar** : Migration vers FullCalendar 6 nécessite réécriture options et callbacks
2. **Format horaire SIP** : Maintenir logique conversion `HH:mm:ss` ↔ `HHmm`
3. **Batch queries** : API requiert batch par chunks de 50 IDs
4. **États condition** : Maintenir machine d'état DRAFT/TO_CREATE/OK/TO_DELETE
5. **3 feature types** : Comportement diffère selon sip/easyHunting/ovhPabx
6. **Iceberg pagination** : Utiliser headers X-Pagination-*

## 8.4 Structure React suggérée

```
src/pages/telecom/telephony/timeCondition/
├── TimeConditionPage.tsx
├── TimeConditionPage.module.css
├── hooks/
│   ├── useTimeCondition.ts
│   ├── useTimeConditionMutations.ts
│   └── useServiceSearch.ts
├── components/
│   ├── TimeConditionCalendar/
│   │   ├── TimeConditionCalendar.tsx
│   │   └── TimeConditionCalendar.module.css
│   ├── TimeConditionSlot/
│   │   ├── TimeConditionSlot.tsx
│   │   └── SlotEditPopover.tsx
│   ├── ConditionEditPopover/
│   │   ├── ConditionEditPopover.tsx
│   │   ├── PolicySelector.tsx
│   │   ├── DayRepeater.tsx
│   │   └── TimeRangePicker.tsx
│   └── ServiceChoice/
│       └── ServiceChoice.tsx
├── types/
│   └── timeCondition.types.ts
├── utils/
│   ├── sipTimeConverter.ts
│   └── conditionValidator.ts
└── api/
    └── timeCondition.api.ts
```

---

# 9. CHECKLIST VÉRIFICATION

- [x] APIs identifiées via patterns OvhApiTelephony
- [x] Endpoints réels documentés (SIP, EasyHunting, OvhPabx)
- [x] Méthodes HTTP correctes (GET/POST/PUT/DELETE)
- [x] Version API : apiv6 exclusivement
- [x] Séquencement documenté (init → getConditions → batch)
- [x] Types TypeScript définis
- [x] Traductions FR/EN complètes
- [x] Règles métier documentées
- [x] Machine d'états conditions documentée
- [x] Recommandations migration fournies

---

# FIN DU CAHIER DES CHARGES
