# CAHIER DES CHARGES - old_manager.web-cloud.emails
# Généré le: 2025-01-06
# Source: old_manager_web-cloud_emails.tar

================================================================================
## 1. RESUME EXECUTIF
================================================================================

### Périmètre fonctionnel

Ce module couvre les fonctionnalités EMAIL intégrées au contexte HOSTING WEB OVHcloud :

| Module | Description | Cible |
|--------|-------------|-------|
| Hosting Email Activate | Activation du pack email inclus dans l'hébergement | Client hébergement web |
| Hosting Email Detach | Détachement de l'option email de l'hébergement | Client souhaitant facturation séparée |
| Hosting Email Terminate | Résiliation de l'option email | Client |
| Hosting Automated Emails | Gestion des scripts email (envoi PHP/scripts) | Développeur/Admin |
| Email Domain Service | Service partagé gestion comptes email domaine | Tous modules email |
| Email Domain Upgrade | Changement d'offre email | Client email domain |
| MXPlan Banner | Bannière info migration OWA/Zimbra | Utilisateurs MXPlan |

### Ce que ce module N'EST PAS

- Module Email Pro standalone
- Module Exchange standalone  
- Dashboard MXPlan complet
- Module Email Domain listing/dashboard

C'est l'ensemble des fonctionnalités email INTEGREES au module Hosting Web.

### Statistiques du code source

- 450 endpoints API uniques
- 124 fichiers source analysés
- 1803 fichiers totaux dans l'archive
- Framework: AngularJS (migration vers React requise)

================================================================================
## 2. ARCHITECTURE
================================================================================

### Arborescence des fichiers

```
old_manager_web-cloud_emails/
│
├── ovh-api-services/src/api/email/
│   ├── domain/
│   │   ├── domain.service.js              # Factory injection
│   │   └── domain.v6.service.js           # $resource /email/domain
│   └── exchange/
│       ├── email-exchange.service.js
│       └── service/
│           ├── email-exchange-service.v6.service.js
│           └── email-exchange-service.aapi.service.js
│
├── packages/manager/modules/web-universe-components/src/
│   ├── email-domain/
│   │   ├── email-domain.service.js        # SERVICE PRINCIPAL (1354 lignes)
│   │   ├── index.js
│   │   └── upgrade/
│   │       ├── upgrade.controller.js
│   │       ├── upgrade.component.js
│   │       ├── upgrade.constants.js
│   │       ├── upgrade.html
│   │       └── translations/Messages_*.json
│   ├── exchange/
│   │   └── exchange.service.js
│   └── mxplan-banner/
│       ├── mxplan-banner.controller.js
│       ├── mxplan-banner.component.js
│       ├── mxplan-banner.constants.js
│       ├── mxplan-banner.html
│       └── translations/Messages_*.json
│
└── packages/manager/apps/web/client/app/hosting/
    ├── email/
    │   ├── hosting-email.service.js       # Service cart/activation
    │   ├── index.js
    │   ├── activate/
    │   │   ├── activate.routing.js
    │   │   ├── activate.controller.js
    │   │   ├── activate.component.js
    │   │   ├── activate.constants.js
    │   │   ├── activate.html
    │   │   ├── activate.module.js
    │   │   └── translations/Messages_*.json
    │   ├── detach/
    │   │   ├── detach.routing.js
    │   │   ├── detach.component.js
    │   │   ├── detach.html
    │   │   └── translations/Messages_*.json
    │   └── terminate/
    │       ├── hosting-email-terminate.controller.js
    │       ├── hosting-email-terminate.component.js
    │       ├── hosting-email-terminate.html
    │       ├── hosting-email-terminate.module.js
    │       └── hosting-email-terminate.routes.js
    │
    └── automated-emails/
        ├── automated-emails.module.js
        ├── automated-emails.routing.js
        ├── hosting-automated-emails.controller.js
        ├── hosting-automated-emails.service.js
        ├── AUTOMATED_EMAILS.html
        ├── error-report/
        │   ├── hosting-automated-emails-error-report.controller.js
        │   └── hosting-automated-emails-error-report.html
        ├── request/
        │   ├── hosting-automated-emails-request.controller.js
        │   └── hosting-automated-emails-request.html
        └── translations/Messages_*.json
```

### Patterns architecturaux

| Pattern | Usage |
|---------|-------|
| Service Angular | Encapsulation appels API (OvhHttp, $http) |
| Controller | Logique vue, gestion états |
| Component | Composant réutilisable avec bindings |
| Routing (ui-router) | Navigation états imbriqués |
| Wizard modal | Formulaires multi-étapes (data-wizard) |

### Dépendances principales

```javascript
// NPM
'chartjs-plugin-datasource-prometheus'
'date-fns'
'lodash'
'@ovh-ux/manager-product-offers'

// Services Angular OVH
OvhHttp, WucOrderCartService, OvhApiHostingWeb, OvhApiOrder
Alerter, WucUser, coreURLBuilder, ChartFactory, Poller
```

================================================================================
## 3. PAGES & NAVIGATION
================================================================================

### Routes

| State | URL | Component | Parent |
|-------|-----|-----------|--------|
| app.hosting.dashboard.activate | /activate | webHostingEmailActivate | app.hosting.dashboard |
| app.hosting.dashboard.detachEmail | /detachEmail | detachEmail | app.hosting.dashboard |
| app.hosting.dashboard.automatedEmails | /automated-emails | HostingTabAutomatedEmailsCtrl | app.hosting.dashboard |

### Resolve (données pré-chargées)

#### Route: activate
```javascript
resolve: {
  domainNames: ($http, $q, Hosting, Domain) => {
    // Fusion domains + hostings + zones
    // Filtre: exclut *.hosting.ovh.net
    // Tri alphabétique
  },
  breadcrumb: ($translate) => $translate.instant('hosting_email_address_activate_title')
}
```

#### Route: detachEmail
```javascript
resolve: {
  goBack: ($state) => () => $state.go('^'),
  emailOptionName: ($translate, emailOptionDetachInformation) => {
    // Traduction du planCode
  },
  pricingType: () => pricingConstants.PRICING_CAPACITIES.DETACH,
  workflow: (emailOptionDetachInformation) => ({
    options: emailOptionDetachInformation[0],
    type: workflowConstants.WORKFLOW_TYPES.SERVICES
  }),
  onError: ($translate, Alerter) => (error) => { /* Alerte erreur */ },
  onSuccess: ($translate, $window, Alerter, goBack) => (result) => { /* Message succès */ },
  breadcrumb: ($translate) => $translate.instant('hosting_email_detach_option_title')
}
```

### Flux utilisateur

#### Activation Email (Stepper 2 étapes)
```
[Dashboard Hosting]
    │
    ▼
[Bouton "Activer vos adresses e-mails"]
    │
    ▼
┌─────────────────────────────────────┐
│ STEP 1: Sélection domaine           │
│ ┌─────────────────────────────────┐ │
│ │ oui-select (searchable)         │ │
│ │ - Liste: domains ∪ hostings ∪ zones │
│ │ - Exclut: *.hosting.ovh.net     │ │
│ └─────────────────────────────────┘ │
│ [Suivant] → createOrder()           │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│ STEP 2: Validation                  │
│ ┌─────────────────────────────────┐ │
│ │ ovh-contracts-summary           │ │
│ │ - Affiche contrats à accepter   │ │
│ │ - Checkbox validation           │ │
│ └─────────────────────────────────┘ │
│ [Annuler] [Activer] → activate()    │
└─────────────────────────────────────┘
    │
    ▼
[Redirection Dashboard + Message succès avec lien suivi commande]
```

#### Scripts Email (Onglet avec 2 vues)
```
[Dashboard Hosting]
    │
    ▼
[Onglet "Scripts e-mail"]
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ INFORMATIONS_VIEW                          │ ACTIONS        │
│ ┌────────────────────────────────────────┐ │ ┌────────────┐ │
│ │ Guide link                             │ │ │ Purger     │ │
│ │ Alert info                             │ │ │ Historique │ │
│ │                                        │ │ │ Bloquer/   │ │
│ │ Status: [badge ok/ko/spam/bounce]      │ │ │ Débloquer  │ │
│ │ Email rapport: xxx@xxx.xx [Modifier]   │ │ └────────────┘ │
│ │ Emails mois: 1234                      │ │                │
│ │ Emails jour: 56 / 200                  │ │                │
│ │ Bounces: 12                            │ │                │
│ │                                        │ │                │
│ │ [Graphique Chart.js - 30 jours]        │ │                │
│ └────────────────────────────────────────┘ │                │
└─────────────────────────────────────────────────────────────┘
    │
    ▼ [Historique des bounces]
┌─────────────────────────────────────────────────────────────┐
│ BOUNCES_VIEW                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [← Retour]                    Limite: [input 0-100]     │ │
│ │                                                         │ │
│ │ ┌─────────┬──────────────────┬────────────────────────┐ │ │
│ │ │ Date    │ Destinataire     │ Message                │ │ │
│ │ ├─────────┼──────────────────┼────────────────────────┤ │ │
│ │ │ 12/01   │ test@example.com │ 550 User unknown       │ │ │
│ │ │ ...     │ ...              │ ...                    │ │ │
│ │ └─────────┴──────────────────┴────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### Modales (wizard)

| Modal | Trigger | Contenu |
|-------|---------|---------|
| Error Report | Clic "Modifier" email rapport | Input email + validation |
| Request BLOCK | Clic "Bloquer" | Confirmation question |
| Request UNBLOCK | Clic "Débloquer" | Confirmation question |
| Request PURGE | Clic "Purger" | Warning + confirmation |

================================================================================
## 4. COMPOSANTS UI
================================================================================

### Composants ODS/OUI utilisés

| Composant | Props/Attributs | Usage |
|-----------|-----------------|-------|
| oui-back-button | on-click | Navigation retour |
| oui-stepper | - | Container wizard |
| oui-step-form | header, submit-text, navigation, prevent-next, editable, on-submit, on-cancel, valid | Étape wizard |
| oui-field | label | Container champ |
| oui-select | name, id, model, placeholder, items, required, searchable | Sélection domaine |
| oui-spinner | size="s/l" | Loading state |
| oui-badge | ng-class | Status coloré |
| oui-button | on-click, variant | Actions |
| oui-tooltip | placement | Info-bulles |
| ovh-contracts-summary | name, items, model | Affichage contrats |
| data-wizard | wizard-on-cancel, wizard-on-finish, wizard-title | Modal wizard AngularJS |
| data-ovh-alert | alert-id | Zone alertes |
| data-chart | chartjs, auto-reload | Graphique Chart.js |

### Mapping ODS React (migration)

| OUI-kit Angular | ODS React |
|-----------------|-----------|
| oui-back-button | OdsButton + OdsIcon chevron |
| oui-stepper/oui-step-form | OdsStepper (à créer ou custom) |
| oui-field | OdsFormField |
| oui-select | OdsSelect |
| oui-spinner | OdsSpinner |
| oui-badge | OdsBadge |
| oui-button | OdsButton |
| oui-tooltip | OdsTooltip |
| data-wizard | Modal custom + steps |
| data-ovh-alert | OdsMessage |

### Classes CSS récurrentes

```css
/* Layout */
.row, .col-md-9, .col-md-3, .col-xs-3, .col-xs-9

/* Espacements */
.pb-4, .mb-3, .mt-5, .mt-lg-0, .ml-2, .pl-1

/* Texte */
.text-center, .text-success, .text-right, .word-break

/* Flexbox */
.d-flex, .d-block, .inline-block, .align-items-center

/* Definition list */
.dl-horizontal, .dl-lg

/* Alertes */
.alert, .alert-info, .alert-warning

/* Boutons */
.btn, .btn-block, .btn-default, .oui-button, .oui-button_ghost, .oui-button_icon-left

/* Tableaux */
.table, .table-hover, .table-responsive

/* Formulaires */
.form-horizontal, .form-inline, .form-group, .form-control, .control-label, .has-error, .help-block

/* Chart */
.chart-container { height: 320px; }
```

### Comportements interactifs

| Élément | Événement | Action |
|---------|-----------|--------|
| Sélection domaine | change | Stocke domainName, active bouton Suivant |
| Bouton Suivant step1 | click | createOrder() → prépare cart API |
| Checkbox contrats | change | Active/désactive bouton Activer |
| Bouton Activer | click | activate() → checkout cart |
| Bouton Modifier email | click | Ouvre modal error-report |
| Bouton Purger | click | Ouvre modal request PURGE |
| Bouton Bloquer | click | Ouvre modal request BLOCK |
| Bouton Débloquer | click | Ouvre modal request UNBLOCK |
| Bouton Historique | click | Switch vers BOUNCES_VIEW |
| Input limite bounces | change | retrievingBounces() avec nouvelle limite |
| Bouton Retour bounces | click | Switch vers INFORMATIONS_VIEW |

================================================================================
## 5. APIs & DONNEES
================================================================================

### Résumé endpoints par catégorie

| Catégorie | Count | Méthodes |
|-----------|-------|----------|
| Email Domain | 70 | GET, POST, PUT, DELETE |
| Email Exchange | 34 | GET |
| Email Hosting | 11 | GET, POST, PUT |
| Hosting Web | 166 | GET, POST, PUT, DELETE |
| Domain | 58 | GET, POST, PUT, DELETE |
| Zone DNS | 24 | GET, POST, PUT |
| 2API SWS | 22 | GET |
| Me Compte | 24 | GET, POST |
| Services | 3 | GET |
| Order | 3 | GET |

### APIs Hosting Email (focus module)

#### HostingAutomatedEmails Service

```typescript
// hosting-automated-emails.service.js

class HostingAutomatedEmails {
  cache = { email: 'UNIVERS_WEB_AUTOMATED_EMAILS' };

  // GET /hosting/web/{serviceName}/email
  // Récupère config emails automatiques
  getAutomatedEmails(serviceName: string): Promise<{
    bounce: number;
    email: string;
    maxPerDay: number;
    sent: number;
    state: 'ok' | 'ko' | 'spam' | 'bounce' | 'purging' | 'force';
  }>;

  // PUT /hosting/web/{serviceName}/email
  // Modifie email de rapport d'erreur
  putEmail(serviceName: string, email: string): Promise<void>;

  // POST /hosting/web/{serviceName}/email/request
  // Actions: BLOCK, UNBLOCK, PURGE
  postRequest(serviceName: string, action: 'BLOCK' | 'UNBLOCK' | 'PURGE'): Promise<void>;

  // GET /hosting/web/{serviceName}/email/bounces?limit=N
  // Liste des bounces
  retrievingBounces(serviceName: string, limit: number): Promise<{
    data: Array<{
      date: string;
      to: string;
      message: string;
    }>;
  }>;
}
```

#### HostingEmailService

```typescript
// hosting-email.service.js

class HostingEmailService {
  // Via OvhApiHostingWeb.EmailOption().v6()
  
  // GET /hosting/web/{serviceName}/emailOption
  getEmailOptionList(serviceName: string): Promise<number[]>;

  // GET /hosting/web/{serviceName}/emailOption/{id}/serviceInfo
  getEmailOptionServiceInformation(serviceName: string, emailOptionId: number): Promise<ServiceInfo>;

  // Workflow Cart
  createCart(ovhSubsidiary: string): Promise<Cart>;
  assignCart(cart: Cart): Promise<Cart>;
  getEmailServiceOptions(cart: Cart, serviceName: string): Promise<{ cart: Cart; option: Option }>;
  addServiceOption(cart: Cart, serviceName: string, option: Option): Promise<Cart>;
  addConfig(cart: Cart, serviceName: string): Promise<Cart>;
  getCheckoutInfo(cart: Cart): Promise<Order>;
  
  // Orchestration complète
  prepareCart(ovhSubsidiary: string, serviceName: string, domainName: string): Promise<{
    ...Order;
    cart: Cart;
  }>;
  
  orderCart(cart: Cart, options?: object): Promise<Order>;
}
```

### APIs Email Domain (service partagé)

```typescript
// email-domain.service.js (1354 lignes)

class EmailDomainService {
  cache = {
    emails: 'UNIVERS_WEB_EMAILS',
    models: 'UNIVERS_WEB_EMAILS_MODELS',
    accounts: 'UNIVERS_WEB_EMAILS_ACCOUNTS',
    acl: 'UNIVERS_WEB_EMAILS_ACL',
    dnsFilter: 'UNIVERS_WEB_DNS_FILTER',
    dnsMxRecords: 'UNIVERS_WEB_DNS_MX_RECORDS',
    works: 'UNIVERS_WEB_EMAILS_WORKS',
    delegation: 'UNIVERS_WEB_EMAILS_DELEGATION',
    delegated: 'UNIVERS_WEB_EMAILS_DELEGATED'
  };

  // === DOMAINES ===
  GET  /email/domain.json                          // getModels()
  GET  /email/domain                               // getDomains()
  GET  /email/domain/{serviceName}                 // getDomain()
  GET  /email/domain/{serviceName}/serviceInfos    // getServiceInfos()
  GET  /email/domain/{serviceName}/summary         // getSummary()
  GET  /email/domain/{serviceName}/quota           // getQuotas()
  GET  /email/domain/{serviceName}/recommendedDNSRecords  // getRecommendedDNSRecords()

  // === COMPTES ===
  GET  /email/domain/{serviceName}/account                    // getEmails(opts)
  GET  /email/domain/{serviceName}/account/{accountName}      // getEmail()
  POST /email/domain/{serviceName}/account                    // createAccount(data)
  PUT  /email/domain/{serviceName}/account/{accountName}      // updateAccount(data)
  DELETE /email/domain/{serviceName}/account/{accountName}    // deleteAccount()
  POST /email/domain/{serviceName}/account/{accountName}/changePassword  // changePasswordAccount()
  GET  /email/domain/{serviceName}/account/{accountName}/usage           // getEmailUsage()
  POST /email/domain/{serviceName}/account/{accountName}/updateUsage     // updateUsage()

  // === FILTRES ===
  GET  /email/domain/{serviceName}/account/{accountName}/filter                     // getFilters()
  GET  /email/domain/{serviceName}/account/{accountName}/filter/{name}              // getFilter()
  POST /email/domain/{serviceName}/account/{accountName}/filter                     // createFilter()
  DELETE /email/domain/{serviceName}/account/{accountName}/filter/{filterName}      // deleteFilter()
  POST /email/domain/{serviceName}/account/{accountName}/filter/{filterName}/changeActivity   // changeFilterActivity()
  POST /email/domain/{serviceName}/account/{accountName}/filter/{filterName}/changePriority   // changeFilterPriority()
  
  // Règles de filtre
  GET  /email/domain/{serviceName}/account/{accountName}/filter/{filterName}/rule         // getRules()
  GET  /email/domain/{serviceName}/account/{accountName}/filter/{filterName}/rule/{id}    // getRule()
  POST /email/domain/{serviceName}/account/{accountName}/filter/{filterName}/rule         // createRule()
  DELETE /email/domain/{serviceName}/account/{accountName}/filter/{filterName}/rule/{id}  // deleteRule()

  // === REDIRECTIONS ===
  GET  /email/domain/{serviceName}/redirection                          // getRedirections(from)
  GET  /email/domain/{serviceName}/redirection/{id}                     // getRedirection()
  POST /email/domain/{serviceName}/redirection                          // createRedirection()
  POST /email/domain/{serviceName}/redirection/{id}/changeRedirection   // updateRedirection()
  DELETE /email/domain/{serviceName}/redirection/{id}                   // deleteRedirection()

  // === REPONDEURS ===
  GET  /email/domain/{serviceName}/responder                    // getResponders()
  GET  /email/domain/{serviceName}/responder/{accountName}      // getResponder()
  POST /email/domain/{serviceName}/responder                    // createResponder()
  PUT  /email/domain/{serviceName}/responder/{accountName}      // updateResponder()
  DELETE /email/domain/{serviceName}/responder/{accountName}    // deleteResponder()
  GET  /email/domain/{serviceName}/task/responder               // getResponderTasks()

  // === ACL ===
  GET  /email/domain/{serviceName}/acl                 // getAcls()
  GET  /email/domain/{serviceName}/acl/{accountId}     // getAcl()
  POST /email/domain/{serviceName}/acl                 // createAcl()
  DELETE /email/domain/{serviceName}/acl/{accountId}   // deleteAcl()

  // === DELEGATION ===
  GET  /email/domain/{serviceName}/account/{accountName}/delegation                    // getDelegationList()
  GET  /email/domain/{serviceName}/account/{accountName}/delegation/{accountId}        // getDelegation()
  POST /email/domain/{serviceName}/account/{accountName}/delegation                    // addDelegation()
  DELETE /email/domain/{serviceName}/account/{accountName}/delegation/{accountId}      // removeDelegation()

  // === DNS ===
  GET  /email/domain/{serviceName}/dnsMXFilter           // getDnsFilter()
  POST /email/domain/{serviceName}/changeDnsMXFilter     // setDnsFilter()
  GET  /email/domain/{serviceName}/dnsMXRecords          // getMxRecords()

  // === DKIM ===
  GET  /email/domain/{serviceName}/dkim           // getDkim()
  PUT  /email/domain/{serviceName}/dkim/enable    // enableDkim()
  PUT  /email/domain/{serviceName}/dkim/disable   // disableDkim()

  // === MIGRATION ===
  GET  /email/domain/{domain}/account/{accountName}/migrate                                                    // getDestinationServices()
  GET  /email/domain/{domain}/account/{accountName}/migrate/{destinationServiceName}                           // getDestinationService()
  GET  /email/domain/{domain}/account/{accountName}/migrate/{destService}/destinationEmailAddress              // getDestinationEmailAddresses()
  GET  /email/domain/{domain}/account/{accountName}/migrate/{destService}/destinationEmailAddress/{email}/checkMigrate   // checkMigrate()
  POST /email/domain/{domain}/account/{accountName}/migrate/{destService}/destinationEmailAddress/{email}/migrate        // migrateAccountToDestinationAccount()

  // === TACHES ===
  GET  /email/domain/{serviceName}/task/account              // getEmailTasks()
  GET  /email/domain/{serviceName}/task/{action}             // getAllTaskIds()
  GET  /email/domain/{serviceName}/task/{action}/{id}        // getTask()

  // === COMPTES DELEGUES ===
  GET  /email/domain/delegatedAccount                                // getDelegatedAccounts()
  GET  /email/domain/delegatedAccount/{email}                        // getDelegatedAccount()
  PUT  /email/domain/delegatedAccount/{email}                        // updateDelegatedAccount()
  POST /email/domain/delegatedAccount/{email}/changePassword         // changeDelegatedPassword()
  GET  /email/domain/delegatedAccount/{email}/usage                  // getDelegatedUsage()
  POST /email/domain/delegatedAccount/{email}/updateUsage            // updateDelegatedUsage()
  GET  /email/domain/delegatedAccount/{email}/filter                 // getDelegatedFilters()
  GET  /email/domain/delegatedAccount/{email}/responder              // getDelegatedResponder()
  POST /email/domain/delegatedAccount/{email}/responder              // createDelegatedResponder()
  PUT  /email/domain/delegatedAccount/{email}/responder              // updateDelegatedResponder()
  DELETE /email/domain/delegatedAccount/{email}/responder            // deleteDelegatedResponder()
}
```

### Séquencement des appels

#### Workflow Activation Email
```
1. WucOrderCartService.createNewCart(ovhSubsidiary)
   └─> POST /order/cart
   
2. WucOrderCartService.assignCart(cartId)
   └─> POST /order/cart/{cartId}/assign
   
3. WucOrderCartService.getProductServiceOptions('webHosting', serviceName)
   └─> GET /order/cartServiceOption/webHosting/{serviceName}
   └─> Filtre: family='mx', prices.pricingMode='default'
   
4. WucOrderCartService.addProductServiceOptionToCart(cartId, 'webHosting', serviceName, options)
   └─> POST /order/cart/{cartId}/webHosting/options
   
5. WucOrderCartService.addConfigurationItem(cartId, itemId, 'mx_domain', domainName)
   └─> POST /order/cart/{cartId}/item/{itemId}/configuration
   
6. WucOrderCartService.getCheckoutInformations(cartId)
   └─> GET /order/cart/{cartId}/checkout
   
7. WucOrderCartService.checkoutCart(cartId, options)
   └─> POST /order/cart/{cartId}/checkout
```

#### Workflow Automated Emails Init
```
1. HostingAutomatedEmails.getAutomatedEmails(productId)
   └─> GET /hosting/web/{productId}/email
   
2. HostingStatistics.getMetricsToken(productId)
   └─> GET /hosting/web/{productId}/metricsToken
   
3. Promise.all([
     retrievingEmailsSum(endpoint, token, dailyStart),    // Prometheus query
     retrievingEmailsSum(endpoint, token, totalStart),    // Prometheus query  
     loadChart(endpoint, token),                          // Chart.js init
     retrievingBounces()                                  // GET /hosting/web/{id}/email/bounces
   ])

4. Si state === 'purging':
   └─> Polling getAutomatedEmails() toutes les 3 secondes
       └─> Arrêt quand state !== 'purging'
```

### Types TypeScript

```typescript
// Automated Emails
interface AutomatedEmailsState {
  bounce: number;
  email: string;
  maxPerDay: number;
  sent: number;
  state: 'ok' | 'ko' | 'spam' | 'bounce' | 'purging' | 'force';
}

interface Bounce {
  date: string;      // ISO date
  to: string;        // Email destinataire
  message: string;   // Message erreur SMTP
}

// Email Option
interface EmailOption {
  id: number;
  domain: string;
  // ... serviceInfo fields
}

// Cart
interface Cart {
  cartId: string;
  itemId?: number;
}

interface CartOption {
  family: string;
  planCode: string;
  prices: Array<{
    pricingMode: string;
    duration: string;
    capacities: string[];
    minimumQuantity: number;
  }>;
}

interface Order {
  orderId: number;
  url: string;
  contracts: Contract[];
  prices: {
    withTax: { text: string; value: number };
    withoutTax: { text: string; value: number };
  };
}

// Email Domain
interface EmailAccount {
  accountName: string;
  domain: string;
  description: string;
  email: string;
  isBlocked: boolean;
  size: number;
}

interface EmailFilter {
  name: string;
  active: boolean;
  action: 'accept' | 'redirect' | 'delete' | 'localCopy';
  actionParam: string;
  header: string;
  operand: 'contains' | 'matches' | 'equals';
  priority: number;
  value: string;
}

interface EmailRedirection {
  id: string;
  from: string;
  to: string;
  localCopy: boolean;
}

interface EmailResponder {
  account: string;
  content: string;
  copy: boolean;
  copyTo: string;
  from: string;
  to: string;
}
```

================================================================================
## 6. TRADUCTIONS
================================================================================

### Clés i18n - Activation Email

```json
{
  "hosting_email_address_activate_title": "Activez vos adresses e-mails",
  "hosting_email_address_activate_description": "Vous n'avez pas encore activé votre pack d'e-mails inclus dans votre offre d'hébergement web. Sélectionnez le nom de domaine que vous souhaitez associer à vos adresses e-mails avant d'activer vos boîtes e-mails.",
  "hosting_email_address_activate_step1_title": "Adresses e-mails",
  "hosting_email_address_activate_step2_title": "Activation",
  "hosting_email_address_activate_choose_domain": "Choisissez le nom de domaine que vous désirez utiliser avec vos e-mails :",
  "hosting_email_address_activate_choose_domain_placeholder": "Sélectionnez un domaine…",
  "hosting_email_address_activate_next": "Suivant",
  "hosting_email_address_activate_cancel": "Annuler",
  "hosting_email_address_activate_activate": "Activer",
  "hosting_email_address_activate_contracts_accept": "Afin de confirmer votre demande, veuillez accepter les conditions d'utilisation.",
  "hosting_email_address_activate_in_progress": "Activation de votre pack d'e-mails",
  "hosting_email_address_activation_error": "Échec de l'activation de l'adresse e-mail : {{message}}",
  "hosting_email_address_activation_success": "L'activation du pack d'adresses e-mails est en cours. <a href=\"{{ orderTrackURL }}\" target=\"_blank\" rel=\"noopener\"> Cliquez ici pour suivre la progression. </a>"
}
```

### Clés i18n - Detach Email

```json
{
  "hosting_email_detach_option_title": "Délier l'option e-mail de mon hébergement",
  "hosting_email_detach_option_description": "L'offre {{ emailOption }} a été choisie en remplacement de l'offre e-mail liée à l'hébergement web {{hosting}}. Délier l'option vous permet de la renouveler de manière indépendante de votre hébergement. L'option vous sera désormais facturée au prix standard des options e-mail.",
  "hosting_email_detach_option_warning_irreversible": "Attention : cette action est irréversible",
  "hosting_email_detach_option_error": "Une erreur est survenue lors du détachement de l'option. {{error}}",
  "hosting_email_detach_option_success_with_payment": "Le détachement de l'option e-mail a bien été pris en compte. Votre compte {{accountId}} a bien été débité de {{price}}. <a class=\"d-block\" target=\"_blank\" href=\"{{billUrl}}\" rel=\"noopener\">Voir ma facture</a>",
  "hosting_email_detach_option_success_with_no_payment": "Votre <a target=\"_blank\" href=\"{{billUrl}}\" rel=\"noopener\">bon de commande</a> a été généré avec succès. Le détachement de l'option e-mail sera effectif après le paiement de celui-ci."
}
```

### Clés i18n - Automated Emails

```json
{
  "hosting_automated_emails": "Scripts e-mail",
  "hosting_tab_AUTOMATED_EMAILS": "Scripts e-mail",
  "hosting_tab_AUTOMATED_EMAILS_info": "Information sur les scripts email",
  "hosting_tab_AUTOMATED_EMAILS_status": "État",
  "hosting_tab_AUTOMATED_EMAILS_status_ok": "Actif",
  "hosting_tab_AUTOMATED_EMAILS_status_ko": "En erreur",
  "hosting_tab_AUTOMATED_EMAILS_status_spam": "Bloqué (spam)",
  "hosting_tab_AUTOMATED_EMAILS_status_bounce": "Bloqué (bounces)",
  "hosting_tab_AUTOMATED_EMAILS_status_purging": "Purge en cours",
  "hosting_tab_AUTOMATED_EMAILS_status_force": "Forcé actif",
  "hosting_tab_AUTOMATED_EMAILS_report_email": "E-mail de rapport d'erreur",
  "hosting_tab_AUTOMATED_EMAILS_report_email_change": "Modifier",
  "hosting_tab_AUTOMATED_EMAILS_total_sent": "E-mails envoyés (mois)",
  "hosting_tab_AUTOMATED_EMAILS_today_sent": "E-mails envoyés (aujourd'hui)",
  "hosting_tab_AUTOMATED_EMAILS_total_bounce": "Bounces",
  "hosting_tab_AUTOMATED_EMAILS_volume": "Volume d'envoi",
  "hosting_tab_AUTOMATED_EMAILS_emails_sent": "E-mails envoyés",
  "hosting_tab_AUTOMATED_EMAILS_purge": "Purger",
  "hosting_tab_AUTOMATED_EMAILS_purge_info": "Supprime les emails en attente pour réinitialiser l'état",
  "hosting_tab_AUTOMATED_EMAILS_purge_title": "Purger les e-mails",
  "hosting_tab_AUTOMATED_EMAILS_purge_question": "Attention : cette action va supprimer tous les e-mails en attente d'envoi. Voulez-vous continuer ?",
  "hosting_tab_AUTOMATED_EMAILS_block": "Bloquer",
  "hosting_tab_AUTOMATED_EMAILS_block_title": "Bloquer les e-mails",
  "hosting_tab_AUTOMATED_EMAILS_block_question": "Voulez-vous bloquer l'envoi d'e-mails depuis vos scripts ?",
  "hosting_tab_AUTOMATED_EMAILS_unblock": "Débloquer",
  "hosting_tab_AUTOMATED_EMAILS_unblock_title": "Débloquer les e-mails",
  "hosting_tab_AUTOMATED_EMAILS_unblock_question": "Voulez-vous débloquer l'envoi d'e-mails depuis vos scripts ?",
  "hosting_tab_AUTOMATED_EMAILS_volume_history": "Historique des bounces",
  "hosting_tab_AUTOMATED_EMAILS_volume_limit": "Limite",
  "hosting_tab_AUTOMATED_EMAILS_bounces_date": "Date",
  "hosting_tab_AUTOMATED_EMAILS_bounces_to": "Destinataire",
  "hosting_tab_AUTOMATED_EMAILS_bounces_message": "Message",
  "hosting_tab_AUTOMATED_EMAILS_bounces_empty": "Aucun bounce",
  "hosting_tab_AUTOMATED_EMAILS_request_success": "Demande effectuée avec succès",
  "hosting_tab_AUTOMATED_EMAILS_request_error": "Une erreur est survenue",
  "hosting_tab_AUTOMATED_EMAILS_err_reports_title": "Modifier l'e-mail de rapport",
  "hosting_tab_AUTOMATED_EMAILS_err_reports_info": "Cet e-mail recevra les rapports d'erreur d'envoi",
  "hosting_tab_AUTOMATED_EMAILS_err_reports_email": "Adresse e-mail",
  "hosting_tab_AUTOMATED_EMAILS_err_reports_email_required": "Ce champ est requis",
  "hosting_tab_AUTOMATED_EMAILS_err_reports_email_invalid": "Adresse e-mail invalide",
  "hosting_tab_AUTOMATED_EMAILS_guide_help": "Consultez notre guide",
  "hosting_tab_AUTOMATED_EMAILS_error": "Erreur lors du chargement",
  "hosting_tab_STATISTICS_none": "Aucune donnée disponible"
}
```

### Clés i18n - MXPlan Banner

```json
{
  "mxplan_banner_info": "Une opération de migration entre la solution OWA et la solution Zimbra est en cours. Vous serez informé du processus par mail. Vous pouvez consulter la FAQ dédiée à cette migration",
  "mxplan_banner_link": "En savoir plus"
}
```

### Clés i18n - Email Domain Upgrade

```json
{
  "email_domain_upgrade_title": "Changer d'offre e-mail",
  "email_domain_upgrade_step_header_offer": "Sélectionnez une offre",
  "email_domain_upgrade_step_header_offer_description": "Sélectionnez l'offre désirée.",
  "email_domain_upgrade_step_header_offer_select_placeholder": "Sélectionnez…",
  "email_domain_upgrade_step_header_duration": "Durée",
  "email_domain_upgrade_step_header_duration_description": "Sélectionnez la durée désirée.",
  "email_domain_upgrade_step_header_validation": "Validation",
  "email_domain_upgrade_next_button_label": "Suivant",
  "email_domain_upgrade_upgrade_button_label": "Changer d'offre",
  "email_domain_upgrade_cancel_button_label": "Annuler",
  "email_domain_upgrade_contracts_accept": "Afin de confirmer votre demande, veuillez accepter les conditions d'utilisation.",
  "email_domain_upgrade_in_progress": "Modification de l'offre e-mail en '{{ newOffer }}'",
  "email_domain_upgrade_fetch_duration_error": "Une erreur s'est produite lors de l'obtention des détails de l'offre : {{message}}",
  "email_domain_upgrade_error": "Impossible de modifier l'offre e-mail : {{message}}",
  "email_domain_upgrade_success": "Le bon de commande <a href=\"{{orderUrl}}\" target=\"_blank\">{{orderId}}</a> a été créé avec succès.",
  "email_domain_upgrade_price_without_tax": "Prix HT : ",
  "email_domain_upgrade_price_with_tax": "Prix TTC : "
}
```

### Clés communes

```json
{
  "common_back": "Retour",
  "common_newtab": "(nouvel onglet)",
  "hosting_guide_help": "Aide"
}
```

================================================================================
## 7. REGLES METIER
================================================================================

### Constantes

```javascript
// activate.constants.js
export const WEB_HOSTING_SERVICE_NAME = 'webHosting';
export const WEB_HOSTING_EMAIL_FAMILY_NAME = 'mx';
export const WEB_HOSTING_EMAIL_PRICING_MODE_DEFAULT = 'default';
export const WEB_HOSTING_CONF_ITEM_LEGACY_DOMAIN = 'mx_domain';
export const WEB_HOSTING_NOT_USABLE_DOMAINS = 'hosting.ovh.net';
```

### États Automated Emails

| État | Signification | Badge | Actions possibles |
|------|---------------|-------|-------------------|
| ok | Service actif, envois OK | success (vert) | Bloquer |
| force | Forcé actif manuellement | success (vert) | Bloquer |
| ko | En erreur technique | error (rouge) | Purger, Débloquer |
| spam | Bloqué pour spam détecté | error (rouge) | Purger, Débloquer |
| bounce | Bloqué pour trop de bounces | error (rouge) | Purger, Débloquer |
| purging | Purge en cours | error + spinner | Aucune (attendre) |

### Conditions d'affichage

```javascript
// Bouton Purger
ng-disabled="(state !== 'ko' && state !== 'spam' && state !== 'bounce') || isPurging"

// Bouton Historique bounces
ng-disabled="loaders.bounces || !thereAreEmailsInError"

// Bouton Bloquer (visible si)
ng-if="state === 'ok' || state === 'force'"

// Bouton Débloquer (visible si)
ng-if="state !== 'ok' && state !== 'force'"
// + désactivé si:
ng-disabled="((state === 'spam' || state === 'bounce') && sent > 0 && !hasBeenPurge) || isPurging"
// => Doit purger avant de débloquer si emails en attente

// Badge couleur
ng-class="{
  'oui-badge_success': state === 'ok' || state === 'force',
  'oui-badge_error': state !== 'ok' && state !== 'force'
}"
```

### Validations

| Champ | Type | Règles |
|-------|------|--------|
| Email rapport | email | required, format email valide |
| Limite bounces | number | required, min=0, max=100 |
| Domaine activation | select | required, non vide |
| Contrats | checkbox | required pour activer |

### Gestion des erreurs

| Code HTTP | Comportement |
|-----------|--------------|
| 401 | Redirection vers page login OVH |
| 460 | Hébergement expiré → return [] (pas d'erreur) |
| 404 (bounces) | `thereAreEmailsInError = false` (normal si pas de bounces) |
| Autres | Affichage message via Alerter.alertFromSWS() |

### Filtres domaines activation

```javascript
// Exclut les domaines se terminant par 'hosting.ovh.net'
filter(domains, (domain) => !endsWith(domain, WEB_HOSTING_NOT_USABLE_DOMAINS))

// Source: union de 3 listes
union(
  Domain.getDomains(),           // GET /domain
  Hosting.getHostings(),         // GET /hosting/web
  $http.get('/domain/zone')      // GET /domain/zone
)

// Tri alphabétique
sortBy(filteredDomains)
```

### Polling Purge

```javascript
// Démarre quand state passe à 'purging'
if (previousState !== 'purging' && newState === 'purging') {
  startPolling();
}

// Polling toutes les 3 secondes
function polling() {
  return getAutomatedEmails(productId).then((data) => {
    if (data.state === 'purging') {
      isPurging = true;
      poll = $timeout(polling, 3000);
    } else {
      isPurging = false;
      hasBeenPurge = true;
      $timeout.cancel(poll);
      retrievingAutomatedEmails();  // Refresh complet
    }
  });
}
```

### Workflow Detach

```javascript
// Utilise @ovh-ux/manager-product-offers
workflow: {
  type: workflowConstants.WORKFLOW_TYPES.SERVICES,
  options: emailOptionDetachInformation[0]  // Premier planCode disponible
}

pricingType: pricingConstants.PRICING_CAPACITIES.DETACH

// Callback succès différent selon paiement
if (!result.autoPayWithPreferredPaymentMethod) {
  // Bon de commande généré, paiement manuel requis
  successMessage = 'hosting_email_detach_option_success_with_no_payment';
} else {
  // Paiement auto effectué
  successMessage = 'hosting_email_detach_option_success_with_payment';
}
```

### Graphique Prometheus

```javascript
// Query Prometheus pour volume emails
const query = `sum without(cluster, statusCode, cluster_name, datacenter, host, host_type, hw_profile, service_name, user) 
  (label_replace(
    (mailout_sendmails_count{service_name="${serviceName}"}), 
    "mail", "sent", "", ""
  )) 
  OR label_replace(vector(0), "mail", "sent", "", "")`;

// Période: 30 derniers jours
timeRange: {
  type: 'relative',
  start: -1 * 30 * 24 * 60 * 60 * 1000,  // -30 jours
  end: 0
}

// Step: 1 heure
step: '1h'
```

### Permissions et contexte

- Module accessible uniquement aux propriétaires d'hébergement web OVH
- L'option email doit être incluse dans l'offre d'hébergement
- Certaines offres n'incluent pas l'option email (vérifier availableOffer)
- Le détachement est irréversible

================================================================================
## ANNEXES
================================================================================

### A. Fichiers sources clés

| Fichier | Lignes | Rôle |
|---------|--------|------|
| email-domain.service.js | 1354 | Service principal email domain |
| hosting-automated-emails.controller.js | 352 | Controller scripts email |
| hosting-email.service.js | 124 | Service activation email |
| exchange.service.js | ~800 | Service Exchange (partagé) |
| activate.controller.js | 80 | Controller activation |
| activate.routing.js | 33 | Routes activation |

### B. Events broadcast

| Event | Trigger | Effet |
|-------|---------|-------|
| hosting.automatedEmails.request.changed | PUT/POST email | Refresh liste |
| hosting.tabs.emails.refresh | CRUD account | Refresh onglet emails |
| hosting.tabs.emails.filters.refresh | CRUD filter | Refresh filtres |
| hosting.tabs.emails.redirections.refresh | CRUD redirection | Refresh redirections |
| hosting.tabs.emails.responders.refresh | CRUD responder | Refresh répondeurs |
| hosting.tabs.emails.acls.refresh | CRUD ACL | Refresh ACL |
| hosting.tabs.emails.delegation.refresh | CRUD delegation | Refresh délégations |
| domain.dashboard.refresh | changeDnsMXFilter | Refresh dashboard domaine |

### C. Caches utilisés

| Cache key | Scope |
|-----------|-------|
| UNIVERS_WEB_AUTOMATED_EMAILS | Automated emails |
| UNIVERS_WEB_EMAILS | Email domains list |
| UNIVERS_WEB_EMAILS_MODELS | Email domain models |
| UNIVERS_WEB_EMAILS_ACCOUNTS | Email accounts |
| UNIVERS_WEB_EMAILS_ACL | ACL list |
| UNIVERS_WEB_DNS_FILTER | DNS filter config |
| UNIVERS_WEB_DNS_MX_RECORDS | MX records |
| UNIVERS_WEB_EMAILS_WORKS | Email tasks |
| UNIVERS_WEB_EMAILS_DELEGATION | Delegations |
| UNIVERS_WEB_EMAILS_DELEGATED | Delegated accounts |

### D. URLs guides

```javascript
// Récupération URL guide
WucUser.getUrlOf('guides').then((guides) => {
  this.guide = get(guides, 'hostingScriptEmail', null);
});
```

### E. Tracking Analytics

```javascript
// Page tracking
atInternet.trackPage({ name: 'web::hosting::scripts' });
```

================================================================================
FIN DU CAHIER DES CHARGES
================================================================================
