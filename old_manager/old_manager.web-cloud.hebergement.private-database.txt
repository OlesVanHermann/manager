# CAHIER DES CHARGES - Module Private Database (Web Cloud Databases)
# Source: old_manager.web-cloud.hebergement.private-database.tar
# Genere le: 2025-01-XX
# Version: 1.0

================================================================================
SECTION 1 - RESUME EXECUTIF
================================================================================

## 1.1 Perimetre fonctionnel

Module de gestion des **Web Cloud Databases** (anciennement "Private Database" / 
"SQL Prive") dans le Manager OVHcloud. Permet de gerer des instances de bases de 
donnees mutualisees de type MySQL, MariaDB, PostgreSQL, Redis/Valkey.

## 1.2 Utilisateurs cibles

- Proprietaires d hebergements web OVHcloud
- Developpeurs necessitant des bases de donnees isolees
- Administrateurs de sites web a fort trafic

## 1.3 Fonctionnalites principales

1. Liste et Dashboard des bases de donnees privees
2. Gestion des utilisateurs et droits (grants)
3. Gestion des bases de donnees (CRUD, dumps, restauration)
4. IPs autorisees (whitelist) pour acces externes
5. Metriques et graphiques de performance
6. Logs (beta avec feature flipping)
7. Configuration avancee du serveur
8. Taches en cours et historique
9. Commande de nouvelles instances (CloudDB)
10. Onboarding pour utilisateurs sans BDD

## 1.4 Types de bases supportees

| Cle | Nom affiche |
|-----|-------------|
| mysql | MySQL |
| mariadb | MariaDB |
| postgresql | PostgreSQL |
| redis | Redis (Caching) |
| valkey | Valkey |

## 1.5 Offres

| Offre | Description |
|-------|-------------|
| classic | SQL Prive classique (legacy) |
| public | Web Cloud Databases (DBaaS) |

================================================================================
SECTION 2 - ARCHITECTURE
================================================================================

## 2.1 Arborescence des fichiers

```
packages/manager/apps/web/client/app/private-database/
|-- index.js                              # Entry point avec lazy loading
|-- private-database.module.js            # Module Angular principal
|-- private-database.routing.js           # Routes niveau liste
|-- private-database.service.js           # Service API principal (1271 lignes)
|-- private-database.constants.js         # Constantes DATABASE_NAMES
|-- private-database.bundle.js            # Bundle webpack
|-- translations/                         # Traductions niveau liste
|
|-- dashboard/                            # Dashboard principal
|   |-- private-database.module.js
|   |-- private-database.routing.js
|   |-- private-database.controller.js
|   |-- private-database.html
|   +-- translations/                     # 513 lignes FR
|
|-- state/                                # Onglet Informations generales
|   |-- state.module.js
|   |-- state.routing.js
|   +-- private-database-state.controller.js
|
|-- user/                                 # Onglet Utilisateurs et droits
|   |-- user.module.js
|   |-- user.routing.js
|   |-- private-database-user.controller.js
|   |-- list/                             # Liste des users
|   |   |-- list.module.js
|   |   |-- list.routing.js
|   |   |-- private-database-user-list.controller.js
|   |   +-- popover/
|   |-- add/                              # Ajouter user
|   |   +-- private-database-user-add.controller.js
|   |-- delete/                           # Supprimer user
|   |   +-- private-database-user-delete.controller.js
|   |-- grants/                           # Gestion des droits
|   |   |-- grants.module.js
|   |   |-- grants.routing.js
|   |   +-- private-database-user-grants.controller.js
|   +-- update/password/                  # Changement MDP
|       |-- private-database-user-update-password.controller.js
|       |-- root/
|       +-- user/
|
|-- database/                             # Onglet Bases de donnees
|   |-- database.module.js
|   |-- database.routing.js
|   |-- private-database-database.controller.js
|   |-- list/                             # Liste des BDD
|   |-- add/                              # Creer BDD
|   |-- delete/                           # Supprimer BDD
|   |-- dump/                             # Dumps (sauvegardes)
|   |   +-- delete/
|   |-- restore/                          # Restaurer dump
|   |-- restore-archive/                  # Restaurer depuis archive
|   |-- import/                           # Importer fichier SQL
|   |-- extension/                        # Extensions PostgreSQL
|   |   +-- private-database-database-extension.service.js
|   |-- archive/                          # Archives (dumps orphelins)
|   |   |-- dump/
|   |   +-- list/
|   |-- certificate/                      # Certificat TLS
|   |-- user/                             # Users par BDD
|   |-- version/update/                   # Changer version
|   |-- ram/update/                       # Commander RAM
|   |-- start/                            # Demarrer serveur
|   |-- stop/                             # Arreter serveur
|   +-- restart/                          # Redemarrer serveur
|
|-- whitelist/                            # Onglet IPs autorisees
|   |-- allowed-ips.module.js
|   |-- allowed-ips.routing.js
|   |-- private-database-whitelist.controller.js
|   |-- private-database-whiteliste.service.js
|   |-- private-database-whitelist.constants.js
|   |-- add/
|   |-- delete/
|   +-- update/
|
|-- metrics/                              # Onglet Metriques
|   |-- metrics.module.js
|   |-- metrics.routing.js
|   +-- private-database-metrics.controller.js
|
|-- logs/                                 # Onglet Logs (beta)
|   |-- private-database-logs.module.js
|   |-- private-database-logs.routing.js
|   |-- private-database-logs.controller.js
|   |-- private-database-logs.service.js
|   +-- data-streams/                     # Composant streaming
|
|-- configuration/                        # Onglet Configuration
|   |-- configuration.module.js
|   |-- configuration.routing.js
|   +-- private-database-configuration.controller.js
|
|-- task/                                 # Onglet Taches
|   |-- task.module.js
|   |-- task.routing.js
|   +-- private-database-task.controller.js
|
|-- oom/                                  # Modal depassements memoire
|   |-- private-database-oom.controller.js
|   +-- private-database-oom.service.js
|
|-- cpu-throttle/                         # Modal saturations CPU
|   |-- private-database-cpu-throttle.controller.js
|   +-- private-database-cpu-throttle.service.js
|
|-- order/clouddb/                        # Commande nouvelle instance
|   |-- index.js
|   |-- private-database-order-clouddb.module.js
|   |-- private-database-order-clouddb.routing.js
|   |-- private-database-order-clouddb.controller.js
|   |-- private-database-order-clouddb.service.js
|   |-- private-database-order-clouddb.constants.js
|   +-- private-database-order-clouddb.component.js
|
+-- onboarding/                           # Page vide / nouveau client
    |-- onboarding.module.js
    |-- onboarding.routing.js
    |-- onboarding.controller.js
    |-- onboarding.component.js
    +-- constants.js
```

## 2.2 Dependances

### Packages OVH
- @ovh-ux/manager-ng-layout-helpers : ListLayoutHelper pour la liste
- @ovh-ux/ng-translate-async-loader : Traductions asynchrones
- @ovh-ux/ui-kit (oui-*) : Composants OUI Kit

### Packages tiers
- angular (1.x) : Framework
- angular-translate : i18n
- @uirouter/angularjs : Routing
- lodash : Utilitaires (clone, filter, forEach, get, map, etc.)
- moment : Manipulation dates
- highcharts : Graphiques metriques

## 2.3 Services principaux

| Service | Fichier | Responsabilite |
|---------|---------|----------------|
| PrivateDatabase | private-database.service.js | API principale (1271 lignes) |
| WhitelistService | private-database-whiteliste.service.js | Gestion whitelist |
| PrivateDatabaseExtension | private-database-database-extension.service.js | Extensions PostgreSQL |
| PrivateDatabaseLogsService | private-database-logs.service.js | Logs Iceberg |
| PrivateDatabaseOrderCloudDb | private-database-order-clouddb.service.js | Commande |
| PrivateDatabaseOom | private-database-oom.service.js | Depassements memoire |
| PrivateDatabaseCpuThrottle | private-database-cpu-throttle.service.js | Saturations CPU |

================================================================================
SECTION 3 - PAGES ET NAVIGATION
================================================================================

## 3.1 Routes UI-Router

| State | URL | Composant/Template | Description |
|-------|-----|-------------------|-------------|
| app.private-database | /private_database | <div ui-view> | Parent, redirect vers index |
| app.private-database.index | ?filter... | managerListLayout | Liste avec pagination Iceberg |
| app.private-database.onboarding | (si liste vide) | onboarding.html | Page onboarding |
| app.private-database.dashboard | /:productId | private-database.html | Dashboard, redirect vers state |
| app.private-database.dashboard.state | | state template | Informations generales |
| app.private-database.dashboard.user | | user template | Utilisateurs et droits |
| app.private-database.dashboard.database | | database template | Bases de donnees |
| app.private-database.dashboard.allowed-ips | | whitelist template | IPs autorisees |
| app.private-database.dashboard.metrics | | metrics template | Metriques (non legacy) |
| app.private-database.dashboard.logs | | logs template | Logs (beta) |
| app.private-database.dashboard.configuration | | configuration template | Configuration |
| app.private-database.dashboard.task | | task template | Taches |
| app.private-database-order-clouddb | /order-cloud-db | order-clouddb template | Commander CloudDB |
| app.sql-order | /configuration/sql_order | redirect | Legacy redirect |

## 3.2 Parametres de route

| Parametre | Type | Description |
|-----------|------|-------------|
| productId | string | serviceName de la base de donnees |

## 3.3 Onglets du Dashboard

| # | Onglet | State | Condition affichage |
|---|--------|-------|---------------------|
| 1 | Informations generales | state | Toujours |
| 2 | Utilisateurs et droits | user | serviceInfos.status !== 'expired' |
| 3 | Bases de donnees | database | serviceInfos.status !== 'expired' |
| 4 | IPs autorisees | allowed-ips | serviceInfos.status !== 'expired' |
| 5 | Metriques | metrics | Non expire ET infrastructure !== 'legacy' |
| 6 | Logs | logs | Feature flag actif ET non expire |
| 7 | Configuration | configuration | Non expire ET non legacy ET hasConfiguration |
| 8 | Taches | task | serviceInfos.status !== 'expired' |

## 3.4 Flux de navigation

### Acces initial
```
/private_database
    |
    +-- Liste vide? --> /private_database (onboarding)
    |
    +-- Liste non vide --> /private_database?filter=...
                               |
                               +-- Clic service --> /private_database/:productId
                                                        |
                                                        +-- redirect --> state
```

### Actions modales
```
Dashboard --> Bouton action --> Modal Bootstrap (#currentAction)
                                    |
                                    +-- Confirmer --> API call --> Poll task --> Refresh
                                    |
                                    +-- Annuler --> Fermer modal
```

## 3.5 Breadcrumb

```
Web Cloud Databases > {serviceName}
```

================================================================================
SECTION 4 - COMPOSANTS UI
================================================================================

## 4.1 Composants OUI Kit utilises

| Composant | Usage | Props/Config |
|-----------|-------|--------------|
| oui-spinner | Loading states | size="l" |
| oui-header | En-tete dashboard | Container + content |
| oui-header-tabs | Navigation onglets | - |
| oui-header-tabs-item | Item onglet | href, active |
| oui-input | Champs texte | ng-model, ng-maxlength, ng-pattern |
| oui-input-group | Groupe input + boutons | - |
| oui-button | Boutons | Variantes: dropdown, icon |
| oui-button_dropdown | Bouton dropdown | - |
| oui-badge | Badge Beta | oui-badge_s oui-badge_success |
| oui-icon | Icones | oui-icon-pen_concept, oui-icon-chevron-down |
| oui-datagrid | Tableaux | Via ListLayoutHelper |

## 4.2 Composants metier OVH

| Composant | Source | Usage |
|-----------|--------|-------|
| wuc-service-expiration-date | web-universe-components | Affichage expiration/renouvellement |
| changelog-button | manager-components | Bouton changelog |
| managerListLayout | manager-ng-layout-helpers | Liste avec filtres Iceberg |
| ovh-alert | manager-components | Zone alertes |

## 4.3 Structure du Dashboard Header

```html
<div class="oui-header">
    <div class="oui-header__container">
        <div class="oui-header__content row">
            <!-- Colonne gauche: Titre + expiration -->
            <div class="col-sm-8">
                <strong>Label type service</strong>
                <h1>displayName || serviceName</h1>
                <span class="font-italic">serviceName (si different)</span>
                <wuc-service-expiration-date>
            </div>
            
            <!-- Colonne droite: Actions -->
            <div class="col-sm-4">
                <changelog-button>
                <div class="btn-group" uib-dropdown>
                    <button class="oui-button oui-button_dropdown">
                        Actions
                    </button>
                    <ul class="dropdown-menu dropdown-menu-right">
                        <li>Redemarrer</li>
                        <li>Changer proprietaire</li>
                        <li>Gestion contacts</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Messages d'information -->
        <p ng-if="state !== 'started'">Serveur non demarre...</p>
        <p ng-if="changeVersion">Migration en cours...</p>
    </div>
    
    <!-- Onglets -->
    <oui-header-tabs>
        <oui-header-tabs-item href="state">Informations generales</oui-header-tabs-item>
        <oui-header-tabs-item href="user">Utilisateurs et droits</oui-header-tabs-item>
        ...
    </oui-header-tabs>
</div>
```

## 4.4 Pattern Modal Bootstrap

```html
<div id="currentAction" class="modal fade currentAction" role="dialog">
    <div class="modal-dialog">
        <div id="modal-container" class="modal-content" ng-include="stepPath">
        </div>
    </div>
</div>
```

Declenchement:
```javascript
$scope.setAction = (action, data) => {
    $scope.currentAction = action;
    $scope.currentActionData = data;
    if (action) {
        $scope.stepPath = `private-database/${action}.html`;
        $('#currentAction').modal({ keyboard: true, backdrop: 'static' });
    } else {
        $('#currentAction').modal('hide');
    }
};
```

## 4.5 Colonnes de la liste principale

| Propriete | Label | Visible par defaut |
|-----------|-------|-------------------|
| serviceName | Nom du service | Oui |
| displayName | Nom personnalise | Oui |
| hostname | Nom d'hote | Oui |
| port | Port | Oui |
| versionLabel | Version | Oui |
| type | Type | Non |
| state | Statut | Non |
| server | Serveur | Non |
| hostnameFtp | Nom d'hote FTP | Non |
| portFtp | Port FTP | Non |
| guiUrl | GUI URL | Non |
| datacenter | Datacentre | Non |
| cpu | CPU | Non |

================================================================================
SECTION 5 - APIs ET DONNEES
================================================================================

## 5.1 Configuration API

```javascript
// Chemins de base
swsProxypassPath = 'apiv6/hosting/privateDatabase';
swsProxypassUpgradePath = 'apiv6/order/upgrade/cloudDB';
rootPath = 'apiv6';
```

## 5.2 Endpoints - Private Database Core

| Methode | Endpoint | Description | Params |
|---------|----------|-------------|--------|
| GET | /hosting/privateDatabase | Liste des services | - |
| GET | /hosting/privateDatabase.json | Modeles API | - |
| GET | /hosting/privateDatabase/availableOrderCapacities | Capacites dispo | offer=public|classic |
| GET | /hosting/privateDatabase/{serviceName} | Details service | - |
| PUT | /hosting/privateDatabase/{serviceName} | Modifier service | body: {displayName} |
| GET | /hosting/privateDatabase/{serviceName}/serviceInfos | Infos service | - |
| GET | /hosting/privateDatabase/{serviceName}/availableVersions | Versions dispo | - |
| GET | /hosting/privateDatabase/{serviceName}/webs | Hebergements lies | - |
| GET | /hosting/privateDatabase/{serviceName}/config | Configuration | - |
| POST | /hosting/privateDatabase/{serviceName}/config/update | Modifier config | body: config object |
| POST | /hosting/privateDatabase/{serviceName}/start | Demarrer | - |
| POST | /hosting/privateDatabase/{serviceName}/stop | Arreter | - |
| POST | /hosting/privateDatabase/{serviceName}/restart | Redemarrer | - |
| POST | /hosting/privateDatabase/{serviceName}/refresh | Rafraichir | - |
| POST | /hosting/privateDatabase/{serviceName}/quotaRefresh | Rafraichir quotas | - |
| POST | /hosting/privateDatabase/{serviceName}/changeVersion | Changer version | body: {version} |
| POST | /hosting/privateDatabase/{serviceName}/changeRootPassword | MDP root | body: {password} |
| POST | /hosting/privateDatabase/{serviceName}/changeFtpPassword | MDP FTP | body: {password} |
| GET | /hosting/privateDatabase/{serviceName}/metricsToken | Token graphiques | - |

## 5.3 Endpoints - Users

| Methode | Endpoint | Description | Params |
|---------|----------|-------------|--------|
| GET | /hosting/privateDatabase/{serviceName}/user | Liste users | - |
| POST | /hosting/privateDatabase/{serviceName}/user | Creer user | body: {userName, password} |
| GET | /hosting/privateDatabase/{serviceName}/user/{userName} | Details user | - |
| DELETE | /hosting/privateDatabase/{serviceName}/user/{userName} | Supprimer user | - |
| POST | /hosting/privateDatabase/{serviceName}/user/{userName}/changePassword | Changer MDP | body: {password} |
| GET | /hosting/privateDatabase/{serviceName}/user/{userName}/grant | Liste grants | - |
| POST | /hosting/privateDatabase/{serviceName}/user/{userName}/grant | Creer grant | body: {databaseName, grant} |
| GET | /hosting/privateDatabase/{serviceName}/user/{userName}/grant/{db} | Detail grant | - |
| POST | /hosting/privateDatabase/{serviceName}/user/{userName}/grant/{db}/update | Modifier grant | body: {grant} |

## 5.4 Endpoints - Databases

| Methode | Endpoint | Description | Params |
|---------|----------|-------------|--------|
| GET | /hosting/privateDatabase/{serviceName}/database | Liste BDD | - |
| POST | /hosting/privateDatabase/{serviceName}/database | Creer BDD | body: {databaseName} |
| POST | /hosting/privateDatabase/{serviceName}/databaseWizard | Creer BDD wizard | body: database object |
| GET | /hosting/privateDatabase/{serviceName}/database/{db} | Details BDD | - |
| DELETE | /hosting/privateDatabase/{serviceName}/database/{db} | Supprimer BDD | - |
| POST | /hosting/privateDatabase/{serviceName}/database/{db}/import | Importer SQL | body: {documentId, flushDatabase, sendEmail} |

## 5.5 Endpoints - Dumps

| Methode | Endpoint | Description | Params |
|---------|----------|-------------|--------|
| GET | /hosting/privateDatabase/{serviceName}/database/{db}/dump | Liste dumps | - |
| POST | /hosting/privateDatabase/{serviceName}/database/{db}/dump | Creer dump | body: {sendEmail} |
| GET | /hosting/privateDatabase/{serviceName}/database/{db}/dump/{id} | Detail dump | - |
| DELETE | /hosting/privateDatabase/{serviceName}/database/{db}/dump/{id} | Supprimer dump | - |
| POST | /hosting/privateDatabase/{serviceName}/database/{db}/dump/{id}/restore | Restaurer | - |
| GET | /hosting/privateDatabase/{serviceName}/dump | Dumps orphelins | orphan=true|false |
| GET | /hosting/privateDatabase/{serviceName}/dump/{id} | Detail orphelin | - |
| POST | /hosting/privateDatabase/{serviceName}/dump/{id}/restore | Restaurer orphelin | body: {databaseName} |

## 5.6 Endpoints - Extensions PostgreSQL

| Methode | Endpoint | Description | Params |
|---------|----------|-------------|--------|
| GET | /hosting/privateDatabase/{serviceName}/database/{db}/extension | Liste | extensionName, status |
| GET | /hosting/privateDatabase/{serviceName}/database/{db}/extension/{ext} | Detail | - |
| POST | /hosting/privateDatabase/{serviceName}/database/{db}/extension/{ext}/enable | Activer | - |
| POST | /hosting/privateDatabase/{serviceName}/database/{db}/extension/{ext}/disable | Desactiver | - |

## 5.7 Endpoints - Whitelist

| Methode | Endpoint | Description | Params |
|---------|----------|-------------|--------|
| GET | /hosting/privateDatabase/{serviceName}/whitelist | Liste IPs | - |
| POST | /hosting/privateDatabase/{serviceName}/whitelist | Ajouter IP | body: {ip, name, service, sftp} |
| GET | /hosting/privateDatabase/{serviceName}/whitelist/{ip} | Detail IP | - |
| PUT | /hosting/privateDatabase/{serviceName}/whitelist/{ip} | Modifier IP | body: {name, service, sftp} |
| DELETE | /hosting/privateDatabase/{serviceName}/whitelist/{ip} | Supprimer IP | - |
| GET | /hosting/privateDatabase/{serviceName}/webhostingNetwork | Statut reseau | - |

## 5.8 Endpoints - OOM et CPU Throttle

| Methode | Endpoint | Description |
|---------|----------|-------------|
| GET | /hosting/privateDatabase/{serviceName}/oom | Depassements memoire |
| GET | /hosting/privateDatabase/{serviceName}/cpuThrottle | Saturations CPU |

## 5.9 Endpoints - Logs

| Methode | Endpoint | Description |
|---------|----------|-------------|
| GET | /hosting/privateDatabase/{serviceName}/log/kind | Types de logs (Iceberg) |
| GET | /hosting/privateDatabase/{serviceName}/log/subscription | Abonnements |
| GET | /hosting/privateDatabase/{serviceName}/log/url | URL logs |

## 5.10 Endpoints - Tasks

| Methode | Endpoint | Description | Params |
|---------|----------|-------------|--------|
| GET | /hosting/privateDatabase/{serviceName}/tasks | Liste taches | status, function |
| GET | /hosting/privateDatabase/{serviceName}/tasks/{id} | Detail tache | - |

## 5.11 Endpoints - Order / Upgrade

| Methode | Endpoint | Description | Params |
|---------|----------|-------------|--------|
| GET | /order/upgrade/cloudDB/{serviceName} | Plans upgrade | - |
| GET | /order/upgrade/cloudDB/{serviceName}/{planCode} | Detail plan | quantity=1 |
| POST | /order/upgrade/cloudDB/{serviceName}/{planCode} | Commander | quantity=1 |
| GET | /order.json | Modeles order | - |

## 5.12 Endpoints - Services

| Methode | Endpoint | Description |
|---------|----------|-------------|
| GET | /services/{serviceId} | Details service parent |

## 5.13 Endpoints - Me (User)

| Methode | Endpoint | Description |
|---------|----------|-------------|
| GET | /me/document | Liste documents |
| GET | /me/document/{documentId} | Detail document |
| POST | /me/document/cors | CORS pour upload |

## 5.14 Sequencement des appels

### Chargement Dashboard
```
1. GET /hosting/privateDatabase/{serviceName}
2. GET /hosting/privateDatabase/{serviceName}/serviceInfos
3. Si non expire:
   GET /hosting/privateDatabase/{serviceName}/tasks?status=todo
   GET /hosting/privateDatabase/{serviceName}/tasks?status=doing
   GET /hosting/privateDatabase/{serviceName}/tasks?status=init
4. Pour chaque task: demarrer polling
```

### Creation User avec Grant
```
1. POST /hosting/privateDatabase/{serviceName}/user
   Response: {id: taskId, function: "..."}
2. Poll: GET /hosting/privateDatabase/{serviceName}/tasks/{taskId}
   Jusqu'a status != todo|doing|init
3. GET /hosting/privateDatabase/{serviceName}/user/{userName}
4. POST /hosting/privateDatabase/{serviceName}/user/{userName}/grant
5. Poll sur la nouvelle task
```

### Import BDD
```
1. POST /me/document/cors
2. Upload fichier vers l'URL retournee
3. POST /hosting/privateDatabase/{serviceName}/database/{db}/import
   body: {documentId, flushDatabase, sendEmail}
4. Poll sur la task
```

### Commande CloudDB
```
1. WucOrderCartService.getProductPublicCatalog(subsidiary, 'webCloudDatabases')
2. WucOrderCartService.getProductOffers(cartId, 'webCloudDatabases')
3. WucOrderCartService.deleteAllItems(cartId)
4. WucOrderCartService.addProductToCart(cartId, ...)
5. WucOrderCartService.addConfigurationItem(cartId, itemId, 'dc', datacenter)
6. WucOrderCartService.addConfigurationItem(cartId, itemId, 'engine', version)
7. WucOrderCartService.getCheckoutInformations(cartId)
8. WucOrderCartService.checkoutCart(cartId, checkout)
```

## 5.15 Types TypeScript (inferres)

### PrivateDatabase
```typescript
interface PrivateDatabase {
  serviceName: string;
  displayName: string;
  hostname: string;
  hostnameFtp: string;
  port: number;
  portFtp: number;
  state: 'started' | 'stopped' | 'startPending' | 'stopPending' | 'restartPending' | 'detached';
  type: string;
  version: string;
  versionLabel: string;
  versionNumber: string;
  offer: 'classic' | 'public';
  infrastructure: 'legacy' | 'docker';
  ram: { value: number; unit: string };
  cpu: number;
  datacenter: string;
  server: string;
  guiUrl: string;
  quotaSize: { value: number; unit: string };
  quotaUsed: { value: number; unit: string };
  capabilities: Record<string, Capability>;
  certificateType: string;
  graphEndpoint?: { host: string; readToken: string };
  serviceInfos?: ServiceInfos;
}

interface ServiceInfos {
  serviceId: number;
  status: 'ok' | 'expired' | 'inCreation';
  renew: { forced: boolean; automatic: boolean };
  expiration: string;
  creation: string;
}
```

### User
```typescript
interface User {
  userName: string;
  creationDate: string;
}

interface Grant {
  databaseName: string;
  grant: 'admin' | 'rw' | 'ro' | 'none';
}
```

### Database
```typescript
interface Database {
  databaseName: string;
  quotaUsed: { value: number; unit: string };
  creationDate: string;
  user: string;
}

interface Dump {
  id: number;
  databaseName: string;
  creationDate: string;
  deletionDate: string;
  url: string;
}
```

### Whitelist
```typescript
interface Whitelist {
  ip: string;      // Format IPv4 ou CIDR
  name: string;    // Description
  service: boolean; // Acces BDD
  sftp: boolean;   // Acces SFTP
  status: 'created' | 'creating' | 'deleting' | 'updating';
}
```

### Task
```typescript
interface Task {
  id: number;
  function: string;
  status: 'todo' | 'doing' | 'done' | 'init' | 'error' | 'cancelled';
  startDate: string;
  doneDate: string;
  lastUpdate: string;
}
```

### Extension
```typescript
interface Extension {
  extensionName: string;
  description: string;
  status: 'disabled' | 'disabling' | 'enabled' | 'enabling';
}
```

### OOM
```typescript
interface OomEvent {
  date: string;
  sizeReached: { value: number; unit: string };
}
```

### CpuThrottle
```typescript
interface CpuThrottleEvent {
  startDate: string;
  endDate: string;
}
```

================================================================================
SECTION 6 - TRADUCTIONS
================================================================================

## 6.1 Fichiers de traduction

| Fichier | Lignes FR | Description |
|---------|-----------|-------------|
| translations/Messages_fr_FR.json | 19 | Liste principale |
| dashboard/translations/Messages_fr_FR.json | 513 | Dashboard complet |
| order/clouddb/translations/Messages_fr_FR.json | 42 | Commande |
| onboarding/translations/Messages_fr_FR.json | 12 | Onboarding |
| + autres sous-modules | ~3 chacun | Breadcrumbs |

## 6.2 Cles principales

```json
{
  "private_databases_title": "Web Cloud Databases",
  "private_databases_order": "Commander",
  "private_database_columns_header_servicename": "Nom du service",
  "private_database_columns_header_displayname": "Nom personnalise du service",
  "private_database_columns_header_hostname": "Nom d'hote",
  "private_database_columns_header_port": "Port",
  "private_database_columns_header_version": "Version",
  "private_database_columns_header_cpu": "CPU",
  "private_database_columns_header_datacenter": "Datacentre",
  "private_database_columns_header_state": "Statut"
}
```

## 6.3 Onglets

```json
{
  "privateDatabase_tab_STATE": "Informations generales",
  "privateDatabase_tab_USER": "Utilisateurs et droits",
  "privateDatabase_tab_DATABASE": "Bases de donnees",
  "privateDatabase_tab_WHITELIST": "IPs autorisees",
  "privateDatabase_tab_LOGS": "Logs",
  "privateDatabase_tab_CONFIGURATION": "Configuration",
  "privateDatabase_tab_TASK": "Taches",
  "privateDatabase_tab_METRICS": "Metriques",
  "privateDatabase_beta_status": "Beta"
}
```

## 6.4 Etats du service

```json
{
  "privateDatabase_dashboard_detached": "Suspendu",
  "privateDatabase_dashboard_restartPending": "Redemarrage en cours",
  "privateDatabase_dashboard_startPending": "Demarrage en cours",
  "privateDatabase_dashboard_started": "Demarre",
  "privateDatabase_dashboard_stopPending": "Arret en cours",
  "privateDatabase_dashboard_stopped": "Arrete"
}
```

## 6.5 Versions de BDD

```json
{
  "privateDatabase_dashboard_version_mariadb": "MariaDB {{version}}",
  "privateDatabase_dashboard_version_mysql": "MySQL {{version}}",
  "privateDatabase_dashboard_version_postgresql": "PostgreSQL {{version}}",
  "privateDatabase_dashboard_version_redis": "Caching {{version}}",
  "privateDatabase_dashboard_version_valkey": "Valkey {{version}}"
}
```

## 6.6 Datacenters

```json
{
  "privateDatabase_dashboard_datacenter_p19": "Paris",
  "privateDatabase_dashboard_datacenter_gra": "eu-west-gra",
  "privateDatabase_dashboard_datacenter_gra1": "eu-west-gra",
  "privateDatabase_dashboard_datacenter_gra2": "eu-west-gra",
  "privateDatabase_dashboard_datacenter_gra3": "eu-west-gra",
  "privateDatabase_dashboard_datacenter_bhs": "ca-east-bhs",
  "privateDatabase_dashboard_datacenter_bhs1": "ca-east-bhs",
  "privateDatabase_dashboard_datacenter_eu-west-gra": "eu-west-gra",
  "privateDatabase_dashboard_datacenter_ca-east-bhs": "ca-east-bhs"
}
```

## 6.7 Whitelist

```json
{
  "privateDatabase_tabs_whitelist_list_ip_network": "Adresse IP / masque",
  "privateDatabase_tabs_whitelist_list_service": "Bases de donnees",
  "privateDatabase_tabs_whitelist_list_service_true": "Autorise",
  "privateDatabase_tabs_whitelist_list_service_false": "Non autorise",
  "privateDatabase_tabs_whitelist_list_sftp": "SFTP",
  "privateDatabase_tabs_whitelist_list_sftp_true": "Autorise",
  "privateDatabase_tabs_whitelist_list_sftp_false": "Non autorise",
  "privateDatabase_tabs_whitelist_list_add_whitelist": "Ajouter une adresse IP / masque",
  "privateDatabase_modale_whitelist_add_ip_tooltip": "L'adresse IP / masque doit etre de type IPv4 (127.0.0.1 ou 127.0.0.0/32)"
}
```

## 6.8 OOM et CPU Throttle

```json
{
  "privateDatabase_no_oom": "Aucun depassement memoire a signaler.",
  "privateDatabase_warning_oom": "{{t0}} depassements memoire ont eu lieu recemment.",
  "privateDatabase_modale_oom_title": "Depassements de la memoire vive",
  "privateDatabase_modale_oom_info": "Depassements de la memoire vive survenus ces {{t0}} derniers jours.",
  "privateDatabase_modale_oom_info_order": "Nous vous conseillons d'augmenter la RAM...",
  "privateDatabase_modale_cpu_throttle_title": "Saturations CPU",
  "privateDatabase_modale_cpu_throttle_info": "Saturations CPU survenues ces {{t0}} derniers jours.",
  "privateDatabase_modale_cpu_throttle_ongoing_cpu_throttle": "Saturation CPU en cours"
}
```

## 6.9 Configuration

```json
{
  "privateDatabase_configuration_alert": "Toute modification entraine un redemarrage du serveur.",
  "privateDatabase_configuration_autoCommit": "Mode auto-commit active ou non...",
  "privateDatabase_configuration_maxConnections": "Nombre maximal de connexions simultanees",
  "privateDatabase_configuration_maxAllowedPacket": "Taille maximale de chaque paquet.",
  "privateDatabase_configuration_innodbBufferPoolSize": "Taille de la memoire tampon (MB)",
  "privateDatabase_configuration_event_scheduler": "Statut de l'orchestrateur d'evenements",
  "privateDatabase_configuration_interactive_timeout": "Timeout connexion interactive",
  "privateDatabase_configuration_wait_timeout": "Timeout connexion externe"
}
```

## 6.10 Onboarding

```json
{
  "private_databases_onboarding_title": "Bases de donnees",
  "private_databases_onboarding_description": "Vous avez la possibilite d'ajouter des bases de donnees...",
  "private_databases_onboarding_order": "Commander une base de donnees Web Cloud Databases",
  "private_databases_onboarding_guide1_title": "Premiers pas avec le service Web Cloud Databases",
  "private_databases_onboarding_guide2_title": "Creer vos bases de donnees et vos utilisateurs...",
  "private_databases_onboarding_guide3_title": "Se connecter a la base de donnees..."
}
```

## 6.11 Commande CloudDB

```json
{
  "private_database_order_clouddb_title": "Commander une base de donnees Web Cloud Databases",
  "private_database_order_clouddb_server_version": "Version du serveur",
  "private_database_order_clouddb_ram_option": "RAM",
  "private_database_order_clouddb_duration": "Choisissez la duree",
  "private_database_order_clouddb_duration_month": "{{ number }} mois",
  "private_database_order_clouddb_payment": "Paiement",
  "private_database_order_clouddb_payment_cancel": "Annuler",
  "private_database_order_clouddb_payment_pay": "Payer",
  "private_database_order_clouddb_payment_checkout_success": "Votre commande... a bien ete prise en compte."
}
```

## 6.12 Langues disponibles

- fr_FR (Francais France)
- fr_CA (Francais Canada)
- en_GB (Anglais)
- de_DE (Allemand)
- es_ES (Espagnol)
- it_IT (Italien)
- pl_PL (Polonais)
- pt_PT (Portugais)

================================================================================
SECTION 7 - REGLES METIER
================================================================================

## 7.1 Etats du service et impacts

| Etat | Actions possibles | Fonctionnalites |
|------|-------------------|-----------------|
| started | Toutes | Toutes actives |
| stopped | Demarrer | Limitees |
| startPending | Aucune (attendre) | Limitees |
| stopPending | Aucune (attendre) | Limitees |
| restartPending | Aucune (attendre) | Limitees |
| detached | Contacter support | Suspendues |
| expired | Renouveler | Aucune |

## 7.2 Conditions d affichage des onglets

```javascript
// Metriques
condition: database.serviceInfos.status !== 'expired' 
        && database.infrastructure !== 'legacy'

// Logs (beta)
condition: isLogsToCustomerFeatureAvailable 
        && database.serviceInfos.status !== 'expired'

// Configuration
condition: database.serviceInfos.status !== 'expired' 
        && database.infrastructure !== 'legacy' 
        && !hasConfiguration
```

## 7.3 Types d infrastructure

| Infrastructure | FTP/SFTP | Port | Caracteristiques |
|----------------|----------|------|------------------|
| legacy | FTP | 21 | Ancien systeme, pas de metriques/config |
| docker | SFTP | Variable | Nouveau systeme, toutes fonctionnalites |

## 7.4 Grants (droits utilisateur)

| Grant | Description | Permissions |
|-------|-------------|-------------|
| admin | Administrateur | Tous droits |
| rw | Lecture/ecriture | SELECT, INSERT, UPDATE, DELETE |
| ro | Lecture seule | SELECT uniquement |
| none | Aucun droit | Pas d'acces |

## 7.5 Validation des champs

### displayName
```javascript
maxlength: 250
pattern: /^[^<>]+$/  // Pas de < ou >
```

### IP Whitelist
```javascript
// Format IPv4 ou CIDR
examples: "127.0.0.1", "192.168.0.0/24", "10.0.0.0/8"
```

### userName
```javascript
// Encode pour URL
encodeURIComponent(userName)
```

### Password
```javascript
// Pas de validation cote front visible
// Validation API
```

## 7.6 Polling des taches

```javascript
// Namespaces de polling
namespaces = {
  'privateDatabase.global.actions': 'Actions globales',
  'privateDatabase.user.create': 'Creation user',
  'privateDatabase.user.delete': 'Suppression user',
  'privateDatabase.user.changePassword': 'Changement MDP',
  'privateDatabase.user.grant.set': 'Modification grant',
  'privateDatabase.database.create': 'Creation BDD',
  'privateDatabase.database.delete': 'Suppression BDD',
  'privateDatabase.database.dump': 'Dump BDD',
  'privateDatabase.database.restore': 'Restauration BDD',
  'privateDatabase.whitelist.create': 'Creation whitelist',
  'privateDatabase.whitelist.delete': 'Suppression whitelist',
  'privateDatabase.database.extension.create': 'Activation extension',
  'privateDatabase.database.extension.delete': 'Desactivation extension',
  'privateDatabase.configuration.change': 'Changement config'
};

// Statuts de tache
statuses = ['init', 'todo', 'doing', 'done', 'error', 'cancelled'];

// Statuts en cours (a poller)
pendingStatuses = ['init', 'todo', 'doing'];
```

## 7.7 Calcul du quota

```javascript
database.quotaPercent = {
  value: (database.quotaUsed.value / database.quotaSize.value) * 100,
  unit: database.quotaSize.unit
};
```

## 7.8 Hostname FTP par defaut

```javascript
if (!database.hostnameFtp) {
  database.hostnameFtp = database.infrastructure === 'legacy'
    ? 'sqlprive.ovh.net'
    : database.hostname.replace('.ha.', '.');
}

if (!database.portFtp) {
  database.portFtp = 21;
}
```

## 7.9 Feature Flags

| Flag | Description |
|------|-------------|
| private-database:logs-to-customer | Active l'onglet Logs (beta) |

```javascript
ovhFeatureFlipping
  .checkFeatureAvailability('private-database:logs-to-customer')
  .then((feature) => 
    feature.isFeatureAvailable('private-database:logs-to-customer')
  );
```

## 7.10 URLs externes

| Type | Construction |
|------|--------------|
| Changement proprietaire | WucUser.getUrlOf('changeOwner') |
| Gestion contacts | coreURLBuilder.buildURL('account', '#/contacts/services', {serviceName}) |
| Guides | WucUser.getUrlOf('guides') |

## 7.11 Graphiques metriques

```javascript
// Configuration OpenTSDB
metricsConfig = {
  queries: [
    {
      metric: 'dbaas.metrics.exec_memsw',
      aggregator: 'sum',
      downsample: '1m-avg' | '1800s-avg' | '7200s-avg'
    },
    {
      metric: 'dbaas.metrics.mysql_threads_connected',
      aggregator: 'sum',
      downsample: '...'
    }
  ]
};

// Periodes
ranges = {
  'DAY': { start: moment().subtract(1, 'days'), downsample: '1m-avg' },
  'WEEK': { start: moment().subtract(1, 'weeks'), downsample: '1800s-avg' },
  'MONTH': { start: moment().subtract(1, 'months'), downsample: '7200s-avg' }
};
```

## 7.12 Constantes Order CloudDB

```javascript
DATACENTER_CONFIGURATION_KEY = 'dc';
ENGINE_CONFIGURATION_KEY = 'engine';
PLAN_CODE_TEMPLATE = 'clouddb-xxxx-runabove';
PRODUCT_NAME = 'webCloudDatabases';
```

## 7.13 Nombre de jours pour suppression

```javascript
NBDAYTODELETE = 30; // Jours avant suppression des dumps
```

================================================================================
ANNEXE A - CONSTANTES
================================================================================

## A.1 DATABASE_NAMES

```javascript
export const DATABASE_NAMES = {
  mysql: 'MySQL',
  mariadb: 'MariaDB',
  postgresql: 'PostgreSQL',
  mongodb: 'MongoDB',
  redis: 'Redis',
  valkey: 'Valkey'
};
```

## A.2 Changelog

```javascript
changelog = 'web_cloud_databases';
```

## A.3 Tracking

```javascript
atInternet.trackClick({
  name: 'web::private-database::index::order',
  type: 'action'
});
```

================================================================================
ANNEXE B - POINTS D ATTENTION MIGRATION
================================================================================

## B.1 Services externes a injecter

- WucOrderCartService : Gestion panier commande
- WucUser : Infos utilisateur et URLs
- Poll : Polling taches asynchrones
- Alerter : Notifications toast
- coreURLBuilder : Construction URLs Manager
- coreConfig : Configuration regionale
- ovhFeatureFlipping : Feature flags
- iceberg : Client API Iceberg

## B.2 Migration AngularJS vers React

| AngularJS | React equivalent |
|-----------|------------------|
| $scope | useState / useContext |
| $rootScope.$broadcast | Custom events / Context |
| ng-if | Conditional rendering |
| ng-repeat | .map() |
| ng-model | Controlled components |
| $http | fetch / axios |
| $q | Promise |
| $translate | react-i18next |
| ui-router | react-router |

## B.3 Composants OUI a migrer vers ODS

| OUI (AngularJS) | ODS (React) |
|-----------------|-------------|
| oui-spinner | OsdsSpinner |
| oui-button | OsdsButton |
| oui-input | OsdsInput |
| oui-badge | OsdsBadge |
| oui-icon | OsdsIcon |
| oui-datagrid | OsdsDatagrid |
| oui-header-tabs | OsdsTabs |

## B.4 Fichiers manquants potentiels

Le tar ne contient pas:
1. Service Hosting (reference dans le controller)
2. Composants partages complets web-universe-components
3. Modaux de certaines actions heritage

================================================================================
FIN DU CAHIER DES CHARGES
================================================================================
