# OVHcloud API Reference - Frontend React (Sans Backend)

## Prérequis

L'utilisateur DOIT être connecté au Manager OVHcloud. Les APIs utilisent les cookies de session.
Pas de AK/AS/CK nécessaire - l'auth est gérée par les cookies.

Si l'app n'est pas hébergée sur un domaine OVH, les cookies cross-site seront bloqués (SameSite/CORS).
Solution : héberger sur un sous-domaine OVH, utiliser un reverse proxy, ou intégrer dans le Manager.

---

## Architecture API

### Proxy Frontend (New Manager)

Le frontend communique avec l'API OVH via un proxy Nginx :
```
/api/ovh/*  →  https://eu.api.ovh.com/1.0/*
```

La signature des requêtes est gérée automatiquement côté serveur.

### Régions et URLs de base

| Région | APIv6 (Iceberg) | 2API | Engine API |
|--------|-----------------|------|------------|
| EU | https://www.ovh.com/engine/apiv6 | https://www.ovh.com/engine/2api-m | https://www.ovh.com/engine/api |
| CA | https://ca.ovh.com/engine/apiv6 | https://ca.ovh.com/engine/2api-m | https://ca.ovh.com/engine/api |
| US | https://us.ovhcloud.com/engine/apiv6 | https://us.ovhcloud.com/engine/2api-m | https://us.ovhcloud.com/engine/api |

### URLs Manager alternatives (équivalentes)

| Région | Manager Engine |
|--------|----------------|
| EU | https://manager.eu.ovhcloud.com/engine/api/v1 |
| CA | https://manager.ca.ovhcloud.com/engine/api/v1 |
| US | https://manager.us.ovhcloud.com/engine/api/v1 |

### URLs Auth (redirection si 401)

| Région | URL Auth |
|--------|----------|
| EU | https://www.ovh.com/auth/?onsuccess=https%3A%2F%2Fwww.ovh.com%2Fmanager |
| CA | https://ca.ovh.com/auth/?onsuccess=https%3A%2F%2Fca.ovh.com%2Fmanager |
| US | https://us.ovhcloud.com/auth/?onsuccess=https%3A%2F%2Fus.ovhcloud.com%2Fmanager |

### Types d'APIs

| API | Usage | Auth | Pagination |
|-----|-------|------|------------|
| apiv6 | API standard, accès direct aux ressources | Cookies session | Headers X-Pagination (Iceberg) |
| 2API (AAPI) | API agrégée/enrichie pour le Manager | Cookies session | Params count/offset |
| Engine API | BFF interne Manager | Cookies session | Standard |

---

## Authentification

### Mode Cookies de Session

L'authentification est gérée automatiquement par les cookies de session OVHcloud.
```typescript
// OBLIGATOIRE : credentials: 'include' pour envoyer les cookies
fetch(url, {
  credentials: 'include',
  headers: { 'Content-Type': 'application/json' },
});
```

### Gestion du 401

Si un appel API retourne 401 (non authentifié), rediriger vers la page de login :
```typescript
if (response.status === 401) {
  window.location.href = AUTH_URLS[region];
}
```

---

## 2API - API Agrégée du Manager

### Description

La 2API est une couche BFF (Backend For Frontend) interne qui agrège et transforme les données de l'APIv6 pour les besoins du Manager. Elle offre des endpoints optimisés avec pagination intégrée.

### Endpoints 2API identifiés (reverse engineering)
```typescript
GET /billing/services?count=10&offset=0&sort=serviceId&sortOrder=asc
GET /billing/autorenew
GET /service/{serviceId}
GET /services
GET /vps/{serviceName}/capabilities
GET /dedicatedCloud/{serviceName}/datacenters-summary
GET /dedicatedCloud/{serviceName}/networks
GET /hosting/web/{serviceName}/domain-configuration
GET /me/notifications
GET /banner
GET /ovhProduct
```

### Paramètres de pagination 2API

| Param | Description | Défaut |
|-------|-------------|--------|
| count | Nombre d'éléments | 25 |
| offset | Décalage | 0 |
| sort | Champ de tri | - |
| sortOrder | 'asc' ou 'desc' | 'asc' |

---

## Iceberg - Pagination moderne (APIv6)

### Headers de requête
```typescript
const headers = {
  'X-Pagination-Mode': 'CachedObjectList-Pages',
  'X-Pagination-Size': '25',
  'X-Pagination-Number': '1',
  'X-Pagination-Sort': 'field',
  'X-Pagination-Sort-Order': 'ASC',
};
```

### Headers de réponse
```typescript
'X-Pagination-Elements': '150'  // total d'éléments
'X-Pagination-Number': '1'      // page actuelle
'X-Pagination-Size': '25'       // taille page
```

---

## Endpoints par catégorie

### Authentification

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| POST | `/auth/credential` | Demande de consumer key |
| GET | `/me` | Informations utilisateur |

### Compte utilisateur (/me)

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/me` | Informations générales |
| PUT | `/me` | Éditer mon compte |
| GET | `/me/contact` | Mes services (contacts) |
| GET | `/me/task/contactChange` | Mes demandes (contact change) |
| GET | `/me/preferences` | Paramètres avancés |
| GET | `/me/supportLevel` | Niveau support |
| GET | `/me/api/application` | Apps API |
| GET | `/me/autorenew` | Config renouvellement |

### Sécurité (2FA)

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/me/accessRestriction/sms` | Liste SMS 2FA |
| GET | `/me/accessRestriction/totp` | Liste TOTP (app mobile) |
| GET | `/me/accessRestriction/u2f` | Liste clés U2F |
| GET | `/me/accessRestriction/backupCode` | Codes de secours |

### Données personnelles (RGPD)

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/me/privacy/requests` | Demandes RGPD |
| POST | `/me/privacy/requests/erasure` | Demande suppression |
| POST | `/me/privacy/requests/export` | Demande export |

### Facturation

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/services` | Mes services (IDs) |
| GET | `/services/{serviceId}` | Détail complet |
| GET | `/me/bill` | Factures |
| GET | `/me/bill/{billId}` | Détails facture |
| GET | `/me/refund` | Avoirs |
| GET | `/me/deposit` | Paiements |
| GET | `/me/deposit/{depositId}` | Détails paiement |
| GET | `/me/order` | Commandes |
| GET | `/me/payment/method` | Moyens de paiement |
| GET | `/me/debtAccount` | Encours/dette |
| GET | `/me/ovhAccount` | Compte prépayé |
| GET | `/me/voucherAccount` | Bons d'achat |
| GET | `/me/fidelityAccount` | Points fidélité |
| GET | `/me/agreements` | Contrats |

### Support

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/support/tickets` | Mes tickets |
| POST | `/support/tickets` | Créer ticket |
| GET | `/support/tickets/{ticketId}` | Détails ticket |
| GET | `/me/supportLevel` | Niveau de support |
| GET | `/me/notification` | Mes communications |
| GET/PUT | `/me/notification/preferences` | Paramètres diffusion |

### IAM

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/me/identity/user` | Liste identités |
| GET | `/iam/policy` | Liste politiques |
| GET | `/me/identity/group` | Liste groupes |
| GET | `/me/logs` | Logs audit |

### Domaines

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/domain` | Liste domaines |
| GET | `/domain/{domain}` | Détail domaine |
| GET | `/domain/zone/{zoneName}` | Zone DNS |
| GET | `/domain/zone/{zoneName}/record` | Records DNS |

### Hébergement Web

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/hosting/web` | Liste hébergements |
| GET | `/hosting/web/{serviceName}` | Détail |
| GET | `/hosting/web/{serviceName}/user` | Utilisateurs FTP |
| GET | `/hosting/web/{serviceName}/database` | Bases de données |

### Email

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/email/domain` | Domaines email |
| GET | `/email/domain/{domain}/account` | Comptes |
| GET | `/email/pro` | Email Pro |
| GET | `/email/exchange` | Exchange |

### VPS

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/vps` | Liste VPS |
| GET | `/vps/{serviceName}` | Détail |
| GET | `/vps/{serviceName}/ips` | IPs |
| GET | `/vps/{serviceName}/datacenter` | Datacenter |

### Serveurs Dédiés

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/dedicated/server` | Liste serveurs |
| GET | `/dedicated/server/{serviceName}` | Détail |
| GET | `/dedicated/server/{serviceName}/specifications/hardware` | Specs |
| GET | `/dedicated/server/{serviceName}/ips` | IPs |

### Cloud (Public Cloud)

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/cloud/project` | Liste projets |
| GET | `/cloud/project/{serviceName}` | Détail projet |
| GET | `/cloud/project/{serviceName}/instance` | Instances |
| GET | `/cloud/project/{serviceName}/storage` | Storage |

### Dedicated Cloud (VMware)

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/dedicatedCloud` | Liste |
| GET | `/dedicatedCloud/{serviceName}` | Détail |

---

## Configuration React

### Service API complet
```typescript
// src/services/ovhApi.ts
type Region = 'EU' | 'CA' | 'US';

const API_URLS: Record<Region, { apiv6: string; api2: string; engine: string }> = {
  EU: {
    apiv6: 'https://www.ovh.com/engine/apiv6',
    api2: 'https://www.ovh.com/engine/2api-m',
    engine: 'https://www.ovh.com/engine/api',
  },
  CA: {
    apiv6: 'https://ca.ovh.com/engine/apiv6',
    api2: 'https://ca.ovh.com/engine/2api-m',
    engine: 'https://ca.ovh.com/engine/api',
  },
  US: {
    apiv6: 'https://us.ovhcloud.com/engine/apiv6',
    api2: 'https://us.ovhcloud.com/engine/2api-m',
    engine: 'https://us.ovhcloud.com/engine/api',
  },
};

const AUTH_URLS: Record<Region, string> = {
  EU: 'https://www.ovh.com/auth/?onsuccess=https%3A%2F%2Fwww.ovh.com%2Fmanager',
  CA: 'https://ca.ovh.com/auth/?onsuccess=https%3A%2F%2Fca.ovh.com%2Fmanager',
  US: 'https://us.ovhcloud.com/auth/?onsuccess=https%3A%2F%2Fus.ovhcloud.com%2Fmanager',
};

class OvhApi {
  private region: Region = 'EU';
  setRegion(region: Region) { this.region = region; }
  getRegion(): Region { return this.region; }

  private async request<T>(baseUrl: string, method: string, path: string, options?: { body?: any; headers?: Record<string, string> }): Promise<T> {
    const response = await fetch(`${baseUrl}${path}`, {
      method,
      credentials: 'include',
      headers: { 'Content-Type': 'application/json', ...options?.headers },
      body: options?.body ? JSON.stringify(options.body) : undefined,
    });
    if (response.status === 401) {
      window.location.href = AUTH_URLS[this.region];
      throw new Error('Non authentifié');
    }
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.message || `Erreur ${response.status}`);
    }
    return response.json();
  }

  async get<T>(path: string): Promise<T> { return this.request(API_URLS[this.region].apiv6, 'GET', path); }
  async post<T>(path: string, body: any): Promise<T> { return this.request(API_URLS[this.region].apiv6, 'POST', path, { body }); }
  async put<T>(path: string, body: any): Promise<T> { return this.request(API_URLS[this.region].apiv6, 'PUT', path, { body }); }
  async delete<T>(path: string): Promise<T> { return this.request(API_URLS[this.region].apiv6, 'DELETE', path); }

  async getIceberg<T>(path: string, options: { page?: number; pageSize?: number; sort?: string; sortOrder?: 'ASC' | 'DESC' } = {}): Promise<{ data: T[]; total: number; page: number }> {
    const { page = 1, pageSize = 25, sort, sortOrder = 'ASC' } = options;
    const headers: Record<string, string> = {
      'X-Pagination-Mode': 'CachedObjectList-Pages',
      'X-Pagination-Size': String(pageSize),
      'X-Pagination-Number': String(page),
    };
    if (sort) { headers['X-Pagination-Sort'] = sort; headers['X-Pagination-Sort-Order'] = sortOrder; }
    const response = await fetch(`${API_URLS[this.region].apiv6}${path}`, { credentials: 'include', headers: { 'Content-Type': 'application/json', ...headers } });
    if (response.status === 401) { window.location.href = AUTH_URLS[this.region]; throw new Error('Non authentifié'); }
    if (!response.ok) { const error = await response.json().catch(() => ({})); throw new Error(error.message || `Erreur ${response.status}`); }
    return { data: await response.json(), total: parseInt(response.headers.get('X-Pagination-Elements') || '0'), page: parseInt(response.headers.get('X-Pagination-Number') || '1') };
  }

  async get2api<T>(path: string, params?: { count?: number; offset?: number; sort?: string; sortOrder?: 'asc' | 'desc' }): Promise<T> {
    const searchParams = params ? '?' + new URLSearchParams(params as Record<string, string>).toString() : '';
    return this.request(API_URLS[this.region].api2, 'GET', `${path}${searchParams}`);
  }
  async post2api<T>(path: string, body: any): Promise<T> { return this.request(API_URLS[this.region].api2, 'POST', path, { body }); }
  async put2api<T>(path: string, body: any): Promise<T> { return this.request(API_URLS[this.region].api2, 'PUT', path, { body }); }
  async delete2api<T>(path: string): Promise<T> { return this.request(API_URLS[this.region].api2, 'DELETE', path); }
}

export const ovhApi = new OvhApi();
```

---

## Debug & Reverse Engineering

1. **DevTools Network** (F12) : Filtrer par `2api-m` ou `engine`
2. **Code source Manager** : Chercher `rootPath: '2api'` ou `.Aapi()`
3. **Repos** : https://github.com/ovh/manager

**Recommandation** : Préférer Iceberg (pagination headers) plutôt que 2API pour les nouvelles features.

---

## Documentation

- Console API : https://api.ovh.com/console/
- GitHub Manager : https://github.com/ovh/manager
- Guides : https://docs.ovh.com/
