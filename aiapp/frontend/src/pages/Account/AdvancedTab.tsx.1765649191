import { useState, useEffect } from "react";
import type { OvhCredentials } from "../../types/auth.types";
import * as accountService from "../../services/account.service";

const STORAGE_KEY = "ovh_credentials";

export default function AdvancedTab() {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [betaEnabled, setBetaEnabled] = useState(false);
  const [developerMode, setDeveloperMode] = useState(false);
  const [savingBeta, setSavingBeta] = useState(false);
  const [savingDev, setSavingDev] = useState(false);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);

  useEffect(() => { loadSettings(); }, []);

  const getCredentials = (): OvhCredentials | null => {
    const stored = sessionStorage.getItem(STORAGE_KEY);
    if (!stored) return null;
    try { return JSON.parse(stored); } catch { return null; }
  };

  const loadSettings = async () => {
    const credentials = getCredentials();
    if (!credentials) { setError("Non authentifie"); setLoading(false); return; }
    setLoading(true);
    setError(null);
    try {
      let devMode = false;
      let betaPref = false;
      try { const devResult = await accountService.getDeveloperMode(credentials); devMode = devResult.enabled; } catch { devMode = false; }
      try { betaPref = await accountService.getBetaPreference(credentials); } catch { betaPref = false; }
      setDeveloperMode(devMode);
      setBetaEnabled(betaPref);
    } catch { /* ignore */ }
    finally { setLoading(false); }
  };

  const showSuccess = (message: string) => { setSuccessMessage(message); setTimeout(() => setSuccessMessage(null), 3000); };

  const handleBetaChange = async (enabled: boolean) => {
    const credentials = getCredentials();
    if (!credentials) return;
    setSavingBeta(true);
    try {
      await accountService.setBetaPreference(credentials, enabled);
      setBetaEnabled(enabled);
      showSuccess(enabled ? "Beta active" : "Beta desactive");
    } catch {
      setBetaEnabled(enabled);
      showSuccess("Sauvegarde locale");
    } finally {
      setSavingBeta(false);
    }
  };

  const handleDeveloperModeChange = async (enabled: boolean) => {
    const credentials = getCredentials();
    if (!credentials) return;
    setSavingDev(true);
    try {
      await accountService.updateDeveloperMode(credentials, enabled);
      setDeveloperMode(enabled);
      showSuccess(enabled ? "Mode dev active" : "Mode dev desactive");
    } catch {
      setDeveloperMode(enabled);
      showSuccess("Sauvegarde locale");
    } finally {
      setSavingDev(false);
    }
  };

  if (loading) return <div className="tab-content"><div className="loading-state"><div className="spinner"></div><p>Chargement...</p></div></div>;

  return (
    <div className="tab-content advanced-tab">
      {successMessage && <div className="success-banner"><span>{successMessage}</span></div>}
      {error && <div className="error-banner"><span>{error}</span></div>}

      <div className="advanced-section">
        <h2>Fonctionnalites Beta</h2>
        <p>Activez pour acceder aux nouvelles fonctionnalites en avant-premiere.</p>
        <div className="beta-toggle-card">
          <label className="toggle-switch">
            <input type="checkbox" checked={betaEnabled} onChange={(e) => handleBetaChange(e.target.checked)} disabled={savingBeta} />
            <span className="toggle-slider"></span>
          </label>
          <span className="toggle-label">{savingBeta ? "Enregistrement..." : "Activer les fonctionnalites Beta"}</span>
        </div>
      </div>

      <div className="advanced-section">
        <h2>Options developpeurs</h2>
        <div className="developer-cards">
          <a href="https://github.com/ovh" target="_blank" rel="noopener noreferrer" className="developer-card">
            <span>Interfaces open-source</span>
          </a>
          <a href="https://github.com/ovh/design-system" target="_blank" rel="noopener noreferrer" className="developer-card">
            <span>Bibliotheque composants</span>
          </a>
          <a href="https://eu.api.ovh.com/console/" target="_blank" rel="noopener noreferrer" className="developer-card">
            <span>Console API</span>
          </a>
        </div>
        <div className="developer-toggle-card">
          <label className="toggle-switch">
            <input type="checkbox" checked={developerMode} onChange={(e) => handleDeveloperModeChange(e.target.checked)} disabled={savingDev} />
            <span className="toggle-slider"></span>
          </label>
          <span className="toggle-label">{savingDev ? "Enregistrement..." : "Mode developpeur"}</span>
        </div>
      </div>

      <div className="advanced-section">
        <h2>Cles API</h2>
        <div className="api-links">
          <a href="https://eu.api.ovh.com/createToken/" target="_blank" rel="noopener noreferrer" className="btn btn-secondary">Creer une cle</a>
          <a href="https://eu.api.ovh.com/console/#/me/api/credential~GET" target="_blank" rel="noopener noreferrer" className="btn btn-secondary">Voir mes cles</a>
        </div>
      </div>

      <div className="advanced-section">
        <h2>Liens</h2>
        <div className="social-links">
          <a href="https://github.com/ovh" target="_blank" rel="noopener noreferrer">GitHub</a>
          <a href="https://community.ovh.com/c/fr" target="_blank" rel="noopener noreferrer">Communaute</a>
        </div>
      </div>
    </div>
  );
}
