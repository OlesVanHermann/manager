# PROMPT SPLIT v2 - Défactorisation Totale (JS + CSS) → Services et Styles Isolés par Tab

Version: v2 (2025-12-31)
Changelog:
- Ajout Pattern B (NAV3/NAV4) pour web-cloud
- Ajout NAV5 (sous-tabs)
- Autorisation composants layout (LeftPanel, RightPanelHeader)
- Ajout helpers, icons, modales
- Clarification patterns locales
- Documentation API multi-offres

## A) Contexte

Tu es un expert en refactoring React/TypeScript pour le projet New Manager OVHcloud.

**Architecture de navigation :**
- **NAV1** : Catégorie principale (ex: general, web-cloud, bare-metal, network...)
- **NAV2** : Sous-catégorie / Produit (ex: billing, hosting, emails, vps...)
- **NAV3** : Groupe de tabs ou toggle mode (ex: general, sites, expert, packs...)
- **NAV4** : Tab fonctionnel (ex: general, ftp, ssl, accounts, redirections...)
- **NAV5** : Sous-tab (ex: dns-config, antispam, signature, resources, audit...)

**Objectif :** DÉFACTORISER un module monolithique (services API + CSS) en modules ISOLÉS, un par tab.

---

## B) PATTERNS DE STRUCTURE

### PATTERN A : Tabs plats (général/*)

**Utilisé par :** `general/*` (billing, account, support, api...)
**Quand :** NAV2 avec tabs linéaires sans groupes

```
src/pages/{NAV1}/{NAV2}/
├── {nav2}.types.ts                  ← Types partagés (SEUL partage)
├── index.tsx
├── index.css                        ← Styles layout (optionnel)
└── tabs/
    └── {nav3}/                      ← Tab = NAV3
        ├── {Nav3}Tab.tsx
        ├── {Nav3}Tab.service.ts
        ├── {Nav3}Tab.css
        ├── {Nav3}Tab.helpers.ts     ← Optionnel
        ├── {Nav3}Tab.icons.tsx      ← Optionnel
        └── index.ts                 ← Export
```

**Exemple :**
```
general/billing/
├── billing.types.ts
├── index.tsx
├── index.css
└── tabs/
    ├── general/
    │   ├── GeneralTab.tsx
    │   ├── GeneralTab.service.ts
    │   ├── GeneralTab.css
    │   ├── GeneralTab.helpers.ts
    │   ├── GeneralTab.icons.tsx
    │   └── index.ts
    ├── invoices/
    │   ├── InvoicesTab.tsx
    │   ├── InvoicesTab.service.ts
    │   ├── InvoicesTab.css
    │   └── index.ts
    └── methods/
        └── ...
```

---

### PATTERN B : NAV3 groupés (web-cloud/*)

**Utilisé par :** `web-cloud/*` (hosting, domains, wordpress, voip...)
**Quand :** NAV2 avec tabs groupés en catégories (General, Sites, Expert...)

```
src/pages/{NAV1}/{NAV2}/
├── {nav2}.types.ts                  ← Types partagés
├── index.tsx
├── styles.css                       ← Styles layout
├── Onboarding.tsx                   ← Optionnel
├── {Nav2}Layout.tsx                 ← Optionnel (layout custom)
│
├── {nav3}/                          ← Groupe NAV3 (ex: general, sites, expert)
│   ├── index.ts                     ← Export du groupe
│   └── {nav4}/                      ← Tab = NAV4
│       ├── {Nav4}Tab.tsx
│       ├── {Nav4}Tab.service.ts
│       ├── {Nav4}Tab.css
│       ├── modals/                  ← Modales du tab (optionnel)
│       │   ├── {Action}Modal.tsx
│       │   └── index.ts
│       └── index.ts
│
└── {nav3b}/                         ← Autre groupe NAV3
    └── ...
```

**Exemple :**
```
web-cloud/hosting/
├── hosting.types.ts
├── index.tsx
├── styles.css
├── Onboarding.tsx
├── HostingLayout.tsx
│
├── general/                         ← NAV3
│   ├── index.ts
│   ├── general/                     ← NAV4
│   │   ├── GeneralTab.tsx
│   │   ├── GeneralTab.service.ts
│   │   ├── GeneralTab.css
│   │   └── index.ts
│   ├── logs/
│   │   ├── LogsTab.tsx
│   │   ├── LogsTab.service.ts
│   │   ├── LogsTab.css
│   │   ├── UserLogsTab.tsx          ← Sous-vue
│   │   └── index.ts
│   └── modules/
│       └── ...
│
├── sites/                           ← NAV3
│   ├── index.ts
│   ├── multisite/
│   │   ├── MultisiteTab.tsx
│   │   ├── MultisiteTab.service.ts
│   │   ├── MultisiteTab.css
│   │   ├── modals/
│   │   │   ├── AddDomainModal.tsx
│   │   │   └── index.ts
│   │   └── index.ts
│   └── ssl/
│       └── ...
│
└── expert/                          ← NAV3
    ├── index.ts
    ├── ftp/
    ├── database/
    ├── cron/
    └── ...
```

---

### PATTERN C : NAV3 toggle (cas spéciaux)

**Utilisé par :** `web-cloud/emails`
**Quand :** 2 modes d'affichage mutuellement exclusifs (toggle dans LeftPanel)

```
src/pages/{NAV1}/{NAV2}/
├── types.ts                         ← Types partagés
├── index.tsx
├── styles.css
├── LeftPanel.tsx                    ← Toggle NAV3 (General/Packs)
├── LeftPanel.css
├── RightPanelHeader.tsx             ← Header contextuel
├── Onboarding.tsx
│
├── {nav3a}/                         ← Mode 1 (ex: general)
│   ├── index.ts
│   ├── {Nav4}Tab.tsx                ← Tabs du mode 1
│   ├── general.css                  ← CSS partagé du mode (optionnel)
│   ├── {nav4-with-subtabs}/         ← NAV4 avec sous-tabs NAV5
│   │   ├── {Nav4}Tab.tsx            ← Conteneur
│   │   ├── {SubTab1}Tab.tsx         ← NAV5
│   │   ├── {SubTab2}Tab.tsx         ← NAV5
│   │   └── index.ts
│   └── ...
│
├── {nav3b}/                         ← Mode 2 (ex: packs)
│   ├── index.ts
│   ├── {Nav4}Tab.tsx
│   └── ...
│
├── api/                             ← APIs par offre (pattern multi-offres)
│   ├── index.ts
│   ├── {offer1}/                    ← ex: mxplan
│   │   ├── accounts.api.ts
│   │   ├── redirections.api.ts
│   │   └── index.ts
│   └── {offer2}/                    ← ex: exchange
│       └── ...
│
└── modals/                          ← Modales partagées (ou à la racine)
    ├── {Action}Modal.tsx
    ├── modals.css
    └── index.ts
```

**Exemple :**
```
web-cloud/emails/
├── types.ts
├── index.tsx
├── styles.css
├── LeftPanel.tsx                    ← Toggle [General] / [Packs]
├── LeftPanel.css
├── DomainView.tsx                   ← Vue domaine dans LeftPanel
├── LicenseView.tsx                  ← Vue licence dans LeftPanel
├── RightPanelHeader.tsx
├── OfferBadge.tsx                   ← Composant partagé (badge offre)
├── Onboarding.tsx
│
├── general/                         ← NAV3 = General
│   ├── index.ts
│   ├── AccountsTab.tsx              ← NAV4
│   ├── RedirectionsTab.tsx
│   ├── RespondersTab.tsx
│   ├── ListsTab.tsx
│   ├── TasksTab.tsx
│   ├── general.css
│   ├── security/                    ← NAV4 avec NAV5
│   │   ├── SecurityTab.tsx          ← Conteneur tabs
│   │   ├── DnsConfigTab.tsx         ← NAV5 (défaut)
│   │   ├── AntispamTab.tsx          ← NAV5
│   │   ├── SignatureTab.tsx         ← NAV5
│   │   └── index.ts
│   └── advanced/                    ← NAV4 avec NAV5
│       ├── AdvancedTab.tsx
│       ├── ResourcesTab.tsx         ← NAV5 (défaut)
│       ├── ContactsTab.tsx
│       ├── AuditTab.tsx
│       ├── DevicesTab.tsx
│       └── index.ts
│
├── packs/                           ← NAV3 = Packs
│   ├── index.ts
│   ├── PacksTab.tsx                 ← NAV4 (index)
│   ├── AlacarteTab.tsx
│   ├── HistoryTab.tsx
│   └── LicensesTab.tsx
│
├── api/
│   ├── index.ts
│   ├── mxplan/
│   ├── exchange/
│   ├── emailpro/
│   └── zimbra/
│
├── AddAliasModal.tsx                ← Modales à la racine
├── ChangePasswordModal.tsx
├── CreateAccountModal.tsx
└── ...
```

---

## C) SOUS-TABS (NAV5)

Certains tabs (NAV4) contiennent des sous-tabs internes (NAV5).

### Structure
```
{nav4}/
├── {Nav4}Tab.tsx            ← Conteneur avec navigation interne
├── {Nav4}Tab.service.ts     ← Service partagé du conteneur (optionnel)
├── {Nav4}Tab.css            ← Styles du conteneur
├── {SubTab1}Tab.tsx         ← Sous-tab 1 (NAV5)
├── {SubTab2}Tab.tsx         ← Sous-tab 2 (NAV5)
├── {SubTab3}Tab.tsx         ← Sous-tab 3 (NAV5)
└── index.ts                 ← Exports
```

### Exemples réels

**security/ (emails) :**
```
security/
├── SecurityTab.tsx           ← Conteneur, gère navigation NAV5
├── DnsConfigTab.tsx          ← NAV5 (défaut) - DKIM, SPF, MX
├── AntispamTab.tsx           ← NAV5 - Filtres, quarantaine
├── SignatureTab.tsx          ← NAV5 - Disclaimer entreprise
└── index.ts
```

**advanced/ (emails, Exchange only) :**
```
advanced/
├── AdvancedTab.tsx           ← Conteneur
├── ResourcesTab.tsx          ← NAV5 (défaut) - Salles, équipements
├── ContactsTab.tsx           ← NAV5 - Contacts externes
├── AuditTab.tsx              ← NAV5 - Logs activité
├── DevicesTab.tsx            ← NAV5 - ActiveSync devices
└── index.ts
```

### Navigation NAV5

Le conteneur (`{Nav4}Tab.tsx`) gère les sous-tabs :

```tsx
// SecurityTab.tsx (conteneur NAV5)
import { DnsConfigTab } from './DnsConfigTab';
import { AntispamTab } from './AntispamTab';
import { SignatureTab } from './SignatureTab';

const subTabs = [
  { id: 'dns', label: 'DNS Config', component: DnsConfigTab },
  { id: 'antispam', label: 'Antispam', component: AntispamTab },
  { id: 'signature', label: 'Signature', component: SignatureTab },
];

export function SecurityTab() {
  const [activeSubTab, setActiveSubTab] = useState('dns');
  const ActiveComponent = subTabs.find(t => t.id === activeSubTab)?.component;

  return (
    <div className="security-container">
      <div className="security-subtabs">
        {subTabs.map(tab => (
          <button
            key={tab.id}
            className={activeSubTab === tab.id ? 'active' : ''}
            onClick={() => setActiveSubTab(tab.id)}
          >
            {tab.label}
          </button>
        ))}
      </div>
      <div className="security-content">
        {ActiveComponent && <ActiveComponent />}
      </div>
    </div>
  );
}
```

---

## D) TRADUCTIONS (Locales)

### Convention par NAV1

| NAV1 | Pattern locales | Exemple |
|------|-----------------|---------|
| `general` | `{nav3}.json` | `invoices.json`, `methods.json` |
| `web-cloud` | `{nav4}.json` | `accounts.json`, `zone.json`, `ftp.json` |
| `public-cloud` | `{nav3}.json` | `general.json`, `snapshots.json` |

### Structure
```
public/locales/{lang}/{NAV1}/{NAV2}/
├── index.json               ← Traductions globales du NAV2
├── {nav3}.json              ← Pattern A : 1 fichier par tab NAV3
├── {nav4}.json              ← Pattern B/C : 1 fichier par tab NAV4
├── modals.json              ← Modales (optionnel, ou dans chaque tab)
└── onboarding.json          ← Onboarding (optionnel)
```

### Exemples

**general/billing/ (Pattern A) :**
```
public/locales/en/general/billing/
├── index.json
├── general.json
├── invoices.json
├── methods.json
├── payments.json
├── orders.json
├── refunds.json
├── contracts.json
└── ...
```

**web-cloud/emails/ (Pattern C) :**
```
public/locales/en/web-cloud/emails/
├── index.json
├── onboarding.json
├── accounts.json        ← NAV4
├── redirections.json
├── responders.json
├── lists.json
├── security.json        ← Inclut NAV5 (dns, antispam, signature)
├── advanced.json        ← Inclut NAV5 (resources, contacts, audit, devices)
├── licenses.json        ← NAV3=packs (tous les tabs)
├── tasks.json
└── modals.json
```

### Pattern legacy (à éviter pour nouveaux modules)
```
# NE PAS UTILISER pour nouveaux modules
web-cloud.hosting.general.json
web-cloud.hosting.database.json

# UTILISER à la place
general.json
database.json
```

---

## E) PRINCIPE DE DÉFACTORISATION (STRICT)

### Définition

**DÉFACTORISATION** = L'inverse de la factorisation/mutualisation.
Au lieu de partager le code commun, on le **DUPLIQUE VOLONTAIREMENT** pour garantir l'**INDÉPENDANCE TOTALE**.

> "Chaque tab est une île. Aucun pont entre les îles. Ni en JS, ni en CSS."

### Pourquoi défactoriser ?

| Factorisation (AVANT)                | Défactorisation (APRÈS)              |
|--------------------------------------|--------------------------------------|
| 1 service partagé = 1 point de casse | N services isolés = 0 régression     |
| 1 CSS partagé = styles qui cassent   | N CSS isolés = styles indépendants   |
| Modifier FTP casse SSL               | Modifier FTP n'impacte QUE FTP       |
| Couplage fort entre tabs             | Couplage ZÉRO entre tabs             |
| "DRY" mal appliqué                   | "WET" assumé (Write Everything Twice)|
| Refacto globale risquée              | Refacto locale safe                  |

### Règle d'or

```
SI deux tabs ont besoin de la même fonction/style/helper :
   → DUPLIQUER le code dans CHAQUE tab
   → NE JAMAIS créer un fichier partagé entre tabs
```

---

## F) INTERDITS ABSOLUS - JAVASCRIPT/TYPESCRIPT

### INTERDIT JS-1 : Import croisé entre tabs

```typescript
// INTERDIT - FtpTab.tsx ne doit JAMAIS faire :
import { sslService } from "../ssl/SslTab";
import { quelqueChose } from "../general/GeneralTab";
import { formatDomain } from "../multisite/MultisiteTab";
```

### INTERDIT JS-2 : Service partagé dans /services/ (niveau global)

```typescript
// INTERDIT - Plus JAMAIS de service mutualisé global :
import { hostingService } from "../../../../../../services/web-cloud.hosting";
import { databaseService } from "../../../../../../services/web-cloud.private-database";
```

### INTERDIT JS-3 : Helper/utils partagé entre tabs au niveau NAV2

```typescript
// INTERDIT - Pas de fichier utils/helpers commun entre tabs :
import { formatDate } from "../../hosting.utils";
import { validateDomain } from "../../hosting.helpers";
```

### INTERDIT JS-4 : Composant partagé interne entre tabs

```typescript
// INTERDIT - Pas de composants mutualisés entre tabs :
import { HostingCard } from "../general/components/HostingCard";
import { DomainSelector } from "../../shared/DomainSelector";
```

### INTERDIT JS-5 : Context/Provider partagé entre tabs

```typescript
// INTERDIT - Pas de context commun entre tabs :
import { useHostingContext } from "../../HostingContext";
import { HostingProvider } from "../../HostingProvider";
```

---

## G) INTERDITS ABSOLUS - CSS/STYLES

### INTERDIT CSS-1 : Import CSS croisé entre tabs

```typescript
// INTERDIT - FtpTab ne doit JAMAIS importer le CSS d'un autre tab :
import "../ssl/SslTab.css";
import styles from "../general/GeneralTab.module.css";
```

### INTERDIT CSS-2 : Classes CSS globales sans préfixe tab

```css
/* INTERDIT - Pas de classes génériques sans préfixe tab */
.hosting-card { }
.hosting-table { }
.hosting-modal { }

/* CORRECT */
.ftp-card { }
.ftp-table { }
```

### INTERDIT CSS-3 : Variables CSS partagées au niveau NAV2 entre tabs

```css
/* INTERDIT - Pas de variables CSS communes entre tabs */
/* hosting-variables.css */
:root {
  --hosting-primary: #0050d7;
}
```

---

## H) AUTORISÉS

### AUTORISÉ 1 : Types partagés au niveau NAV2 (SEULE exception JS majeure)

```typescript
// OK - Un seul fichier types partagé
import type { HostingInfo, FtpUser, SslCertificate } from "../../hosting.types";
```

**Pourquoi ?** Les types sont des contrats d'API, pas du code exécutable.

### AUTORISÉ 2 : Services API globaux (/services/api.ts)

```typescript
// OK - Fonctions API bas niveau
import { ovhGet, ovhPost, ovhPut, ovhDelete } from "../../../../../../services/api";
```

### AUTORISÉ 3 : Composants design system global (/components/)

```typescript
// OK - Composants UI génériques
import { Button, Modal, Table, Alert } from "../../../../../../components/ui";
import { DataGrid } from "../../../../../../components/DataGrid";
```

### AUTORISÉ 4 : CSS design system global (/styles/)

```css
/* OK - Utiliser les variables CSS globales */
.ftp-card {
  color: var(--ods-color-primary);
  padding: var(--ods-spacing-md);
}
```

### AUTORISÉ 5 : Hooks globaux (/hooks/)

```typescript
// OK - Hooks génériques
import { useApi } from "../../../../../../hooks/useApi";
import { useToast } from "../../../../../../hooks/useToast";
```

### AUTORISÉ 6 : Duplication JS ASSUMÉE entre tabs

```typescript
// OK - Si FTP et SSL ont besoin de formatDate(), CHAQUE tab a SA copie :

// tabs/ftp/FtpTab.helpers.ts
export const formatDate = (d: string) => new Date(d).toLocaleDateString("fr-FR");

// tabs/ssl/SslTab.helpers.ts
export const formatDate = (d: string) => new Date(d).toLocaleDateString("fr-FR");
```

### AUTORISÉ 7 : Duplication CSS ASSUMÉE entre tabs

```css
/* OK - Si FTP et SSL ont besoin du même style, CHAQUE tab a SA copie */

/* tabs/ftp/FtpTab.css */
.ftp-status-badge {
  padding: 4px 8px;
  border-radius: 4px;
}

/* tabs/ssl/SslTab.css */
.ssl-status-badge {
  padding: 4px 8px;
  border-radius: 4px;
}
```

### AUTORISÉ 8 : Helpers par tab

```typescript
// OK - Fichier helpers local au tab
// tabs/invoices/InvoicesTab.helpers.ts
export const formatAmount = (amount: number) => `${amount.toFixed(2)} €`;
export const formatDate = (d: string) => new Date(d).toLocaleDateString("fr-FR");
```

### AUTORISÉ 9 : Icons par tab

```typescript
// OK - Composants icons locaux au tab
// tabs/invoices/InvoicesTab.icons.tsx
export const InvoiceIcon = () => <svg>...</svg>;
export const DownloadIcon = () => <svg>...</svg>;
```

### AUTORISÉ 10 : Composants de layout au niveau NAV2

```typescript
// OK - Composants de structure partagés pour le layout
// Pattern C uniquement (toggle NAV3)
import { LeftPanel } from "./LeftPanel";
import { RightPanelHeader } from "./RightPanelHeader";

// Composants de vue pour LeftPanel
import { DomainView } from "./DomainView";
import { LicenseView } from "./LicenseView";
```

**Condition :** Ces composants sont du LAYOUT, pas de la logique métier.

### AUTORISÉ 11 : Composants réutilisables de présentation au niveau NAV2

```typescript
// OK - Petits composants de présentation sans logique métier
import { OfferBadge } from "./OfferBadge";     // Badge Exchange/Pro/Zimbra
import { StatusBadge } from "./StatusBadge";   // Badge active/inactive
```

**Condition :** Pas de logique métier, uniquement de l'affichage.

### AUTORISÉ 12 : API par offre (Pattern multi-offres)

```typescript
// OK - APIs séparées par offre technique
// Pattern C (emails) : chaque offre a ses propres endpoints

// api/mxplan/accounts.api.ts
export const getMxPlanAccounts = (domain: string) =>
  ovhGet(`/email/domain/${domain}/account`);

// api/exchange/accounts.api.ts
export const getExchangeAccounts = (org: string, service: string) =>
  ovhGet(`/email/exchange/${org}/service/${service}/account`);
```

### AUTORISÉ 13 : Modales à la racine NAV2 (Pattern C)

```typescript
// OK pour Pattern C - Modales partagées entre modes General/Packs
// web-cloud/emails/CreateAccountModal.tsx
// web-cloud/emails/ChangePasswordModal.tsx
```

**Condition :** Les modales sont vraiment transversales aux deux modes.

---

## I) CONVENTIONS DE NOMMAGE

### Fichiers

| Élément          | Convention (Pattern A)    | Convention (Pattern B/C)  |
|------------------|---------------------------|---------------------------|
| Types            | `{nav2}.types.ts`         | `{nav2}.types.ts` ou `types.ts` |
| Service          | `{Nav3}Tab.service.ts`    | `{Nav4}Tab.service.ts`    |
| Composant        | `{Nav3}Tab.tsx`           | `{Nav4}Tab.tsx`           |
| Styles           | `{Nav3}Tab.css`           | `{Nav4}Tab.css`           |
| Helpers          | `{Nav3}Tab.helpers.ts`    | `{Nav4}Tab.helpers.ts`    |
| Icons            | `{Nav3}Tab.icons.tsx`     | `{Nav4}Tab.icons.tsx`     |
| Traductions      | `{nav3}.json`             | `{nav4}.json`             |

### Classes CSS

**Préfixe OBLIGATOIRE par tab pour éviter les collisions :**

| Tab         | Préfixe         | Exemples                              |
|-------------|-----------------|---------------------------------------|
| general     | `.general-`     | `.general-card`, `.general-header`    |
| ftp         | `.ftp-`         | `.ftp-user`, `.ftp-quota`             |
| ssl         | `.ssl-`         | `.ssl-cert`, `.ssl-status`            |
| accounts    | `.accounts-`    | `.accounts-table`, `.accounts-row`    |
| security    | `.security-`    | `.security-tabs`, `.security-content` |

### Imports type par pattern

**Pattern A (general/billing/tabs/invoices/) :**
```typescript
import { ovhGet, ovhPost } from "../../../../../../services/api";
import type { BillingInfo } from "../../billing.types";
import { invoicesService } from "./InvoicesTab.service";
import { formatAmount } from "./InvoicesTab.helpers";
import "./InvoicesTab.css";
```

**Pattern B (web-cloud/hosting/expert/ftp/) :**
```typescript
import { ovhGet, ovhPost } from "../../../../../../services/api";
import type { HostingInfo } from "../../hosting.types";
import { ftpService } from "./FtpTab.service";
import "./FtpTab.css";
```

**Pattern C (web-cloud/emails/general/) :**
```typescript
import { ovhGet, ovhPost } from "../../../../../services/api";
import type { EmailDomain, EmailAccount } from "../types";
import { mxplanApi } from "../api/mxplan";
import { exchangeApi } from "../api/exchange";
import "./general.css";
```

---

## J) INDÉPENDANCE ENTRE NIVEAUX

| Relation | Indépendance | Partage autorisé |
|----------|--------------|------------------|
| **NAV1 ↔ NAV1** | TOTALE | Globaux uniquement (`/services/api.ts`, `/components/ui`, `/hooks/`) |
| **NAV2 ↔ NAV2** | TOTALE | Globaux uniquement |
| **NAV3 ↔ NAV3** | TOTALE | Types NAV2 (`{nav2}.types.ts`) |
| **NAV4 ↔ NAV4** | TOTALE | Types NAV2, Layout NAV2 (LeftPanel, etc.) |
| **NAV5 ↔ NAV5** | Partielle | Conteneur NAV4, types NAV2 |

---

## K) WORKFLOW DE DÉFACTORISATION

### PHASE 1 : ANALYSE

```bash
# 1. Identifier le pattern du module
ls -la src/pages/{nav1}/{nav2}/

# 2. Lister les méthodes du service monolithique (si existant)
grep -n "export.*function\|export.*const.*=" services/{nav1}.{nav2}.ts

# 3. Lister les types
grep -n "export.*type\|export.*interface" src/pages/{nav1}/{nav2}/*.types.ts

# 4. Lister les classes CSS utilisées
grep -roh 'className="[^"]*"' src/pages/{nav1}/{nav2}/ | sort | uniq -c | sort -rn

# 5. Identifier les imports croisés existants
grep -rn "from.*\.\./" src/pages/{nav1}/{nav2}/
```

### PHASE 2 : CRÉATION STRUCTURE

```bash
# Pattern A : Créer tabs/{nav3}/
mkdir -p src/pages/{nav1}/{nav2}/tabs/{nav3}

# Pattern B : Créer {nav3}/{nav4}/
mkdir -p src/pages/{nav1}/{nav2}/{nav3}/{nav4}
```

### PHASE 3 : CRÉATION FICHIERS PAR TAB

Pour chaque tab, créer :
1. `{Tab}Tab.tsx` - Composant
2. `{Tab}Tab.service.ts` - Service API isolé
3. `{Tab}Tab.css` - Styles isolés
4. `{Tab}Tab.helpers.ts` - Helpers (optionnel)
5. `index.ts` - Export

### PHASE 4 : VÉRIFICATION ISOLATION

```bash
# Tests d'isolation JS (doivent retourner 0 résultat)
echo "=== Imports croisés entre tabs ==="
grep -rn "from.*\.\.\/.*Tab" src/pages/{nav1}/{nav2}/

echo "=== Ancien service monolithique ==="
grep -rn "from.*services/{nav1}\.{nav2}" src/pages/{nav1}/{nav2}/

# Tests d'isolation CSS (doivent retourner 0 résultat)
echo "=== Import CSS croisé entre tabs ==="
grep -rn "import.*\.\.\/.*\.css" src/pages/{nav1}/{nav2}/
```

### PHASE 5 : BUILD

```bash
cd /home/ubuntu/aiapp/frontend && npm run build:dev
```

---

## L) RÉCAPITULATIF DES PATTERNS

| Aspect | Pattern A | Pattern B | Pattern C |
|--------|-----------|-----------|-----------|
| **NAV1** | general | web-cloud | web-cloud |
| **Structure** | `tabs/{nav3}/` | `{nav3}/{nav4}/` | `{nav3}/` + toggle |
| **Tab level** | NAV3 | NAV4 | NAV4 |
| **Sous-tabs** | Non | Rarement | Oui (NAV5) |
| **Layout partagé** | Non | Optionnel | Oui (LeftPanel) |
| **Multi-offres** | Non | Non | Oui (api/{offer}/) |
| **Modales** | Dans tab | Dans tab | Racine ou tab |
| **Locales** | `{nav3}.json` | `{nav4}.json` | `{nav4}.json` |

---

## M) RAPPEL FINAL

> **DÉFACTORISATION = DUPLICATION VOLONTAIRE (JS + CSS)**
>
> Si tu hésites entre "factoriser pour éviter la duplication" et "dupliquer pour garantir l'isolation" :
>
> **→ TOUJOURS CHOISIR L'ISOLATION**
>
> Le coût de la duplication (quelques lignes JS/CSS en plus) est INFINIMENT plus faible que le coût du couplage (régressions en cascade, styles qui cassent, tests impossibles).
>
> **"Chaque tab est une île. Aucun pont entre les îles. Ni en JS, ni en CSS."**
>
> **EXCEPTIONS DOCUMENTÉES :**
> - Types NAV2 (`{nav2}.types.ts`)
> - Composants layout (LeftPanel, RightPanelHeader)
> - Composants présentation (OfferBadge, StatusBadge)
> - APIs multi-offres (`api/{offer}/`)
