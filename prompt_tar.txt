# Objectif
Générer 2 scripts bash pour créer des archives tar granulaires des managers (new et old), permettant d'uploader uniquement les fichiers nécessaires au travail du jour.

# RÈGLES ABSOLUES (LIRE EN PREMIER)

## Règle 1 : Extraction stricte - JAMAIS inventer
**INTERDIT d'inventer ou déduire des chemins.**
- Chaque chemin DOIT être extrait VERBATIM des listes fournies
- Si un fichier/dossier attendu n'existe pas dans la liste → NE PAS l'inclure
- En cas de doute → grep la liste pour vérifier

**INTERDIT :**
```bash
# J'imagine que ce fichier existe basé sur une convention
./src/pages/bare-metal/dedicated/tabs/StorageTab.tsx  # ✗ INVENTÉ
```

**CORRECT :**
```bash
# J'ai vérifié dans new_manager_files.txt : ligne 847
./src/pages/bare-metal/dedicated/tabs/NetworkTab.tsx  # ✓ EXISTE
```

## Règle 2 : Dossiers plutôt que fichiers individuels
**Utiliser des DOSSIERS entiers** pour éviter les erreurs de noms.

**MAUVAIS (fragile) :**
```bash
tar -cf archive.tar \
  ./src/pages/home/billing/tabs/PaymentsTab.tsx \
  ./src/pages/home/billing/tabs/OrdersTab.tsx \
  ./src/pages/home/billing/tabs/ServicesTab.tsx
```

**BON (robuste) :**
```bash
tar -cf archive.tar \
  ./src/pages/home/billing
```

**Exception** : Fichiers core isolés (index.tsx, styles.css à la racine d'un NAV1)

## Règle 3 : Validation avant génération
**AVANT de générer les scripts**, pour chaque tar :
1. Lister les dossiers/fichiers à inclure
2. Vérifier que chaque chemin existe dans la liste fournie
3. Signaler les chemins introuvables

# Entrées
- Liste de fichiers `new_manager` (fichier joint)
- Liste de fichiers `old_manager` (fichier joint)

# Chemins réels
- `new_manager` = `/home/ubuntu/aiapp/frontend` (React/Vite)
- `old_manager` = `/home/ubuntu/manager/` (Angular monorepo avec packages/)

# Nommage des tars (CRITIQUE)
Format OBLIGATOIRE : `{prefix}.{domaine}.tar`
- Séparateur entre prefix et domaine : `.` (POINT, pas underscore)
- Séparateur entre NAV1 et NAV2 : `.` (POINT)
- JAMAIS de `_` (underscore) après le prefix

**Exemples de noms CORRECTS :**
- `new_manager.core.tar` ✓
- `new_manager.home.core.tar` ✓
- `new_manager.home.billing.tar` ✓
- `new_manager.public-cloud.kubernetes.tar` ✓
- `new_manager.all.tar` ✓
- `old_manager.home.billing.tar` ✓

**Exemples de noms INCORRECTS (INTERDIT) :**
- `new_manager_core.tar` ✗
- `new_manager_home.billing.tar` ✗
- `new_manager_home.account.tar` ✗

**Exemples de commandes tar CORRECTES :**
```bash
tar -cf /home/ubuntu/new_manager.home.billing.tar ./src/pages/home/billing
tar -cf /home/ubuntu/new_manager.home.account.tar ./src/pages/home/account
tar -cf /home/ubuntu/old_manager.home.billing.tar ./packages/manager/modules/billing
```

**Exemples de commandes tar INCORRECTES (INTERDIT) :**
```bash
tar -cf /home/ubuntu/new_manager_home.billing.tar ...  # ✗ underscore
tar -cvf /home/ubuntu/new_manager_home.account.tar ... # ✗ underscore + verbose
```

# Structure des tars

## Niveaux de granularité
1. `{prefix}.core.tar` : Config globale + design-system + lib + services de base
2. `{prefix}.{NAV1}.core.tar` : Structure de base du domaine NAV1 (index, styles, shared, components directs)
3. `{prefix}.{NAV1}.{NAV2}.tar` : Sous-domaine complet (PRIORITAIRE pour le travail quotidien)
4. `{prefix}.all.tar` : Tous les fichiers (refactoring global)

## Contenu des tars NAV1.core
Inclure les fichiers/dossiers DIRECTS du NAV1 (pas les sous-domaines NAV2) :
```
./src/pages/{NAV1}/index.tsx
./src/pages/{NAV1}/routes.tsx (si existe)
./src/pages/{NAV1}/styles.css (si existe)
./src/pages/{NAV1}/utils.ts (si existe)
./src/pages/{NAV1}/types.ts (si existe)
./src/pages/{NAV1}/constants.ts (si existe)
./src/pages/{NAV1}/shared/ (si existe)
./src/pages/{NAV1}/shared.tsx (si existe)
./src/pages/{NAV1}/components/ (si existe, PAS les sous-domaines)
./src/pages/{NAV1}/hooks/ (si existe)
```

**NE PAS inclure** les sous-dossiers NAV2 (billing/, account/, hosting/, etc.)

Exemple pour `new_manager.home.core.tar` :
```
src/pages/home/index.tsx
src/pages/home/routes.tsx
src/pages/home/shared.tsx
src/pages/home/shared/ServiceListPage.tsx
src/pages/home/shared/ServiceItem.tsx
src/pages/home/hooks/useHomeServices.ts
src/pages/home/types.ts
```

## Contenu des tars NAV2
Inclure :
- Le dossier NAV2 complet : `./src/pages/{NAV1}/{NAV2}/`
- Le shared du parent : `./src/pages/{NAV1}/shared/` ou `./src/pages/{NAV1}/shared.tsx` (si existe)
- Les services associés : `./src/services/{nav1}.{nav2}.ts` (si existe)
- Les locales : `./public/locales/{en,fr}/{nav1}/{nav2}/` (si existe)

## Imports shared parent (CRITIQUE)
**Les imports `../../shared` ou `../shared` référencent des composants partagés AU NIVEAU DU DOMAINE.**

Exemple :
```tsx
// Dans src/pages/web-cloud/hosting/HostingList.page.tsx
import { ServiceListPage, ServiceItem } from "../../shared";
```

Résolution :
- `src/pages/web-cloud/shared.tsx`
- Ou `src/pages/web-cloud/shared/index.tsx`

**RÈGLE : Chaque tar NAV2 DOIT inclure le shared du domaine parent.**

Quand on génère `new_manager.web-cloud.hosting.tar`, inclure aussi :
- `src/pages/web-cloud/shared.tsx` (si existe)
- `src/pages/web-cloud/shared/` (si existe)

# Correspondance new ↔ old (CRITIQUE)
**old_manager DOIT avoir un tar pour CHAQUE tar de new_manager.**

Pour chaque NAV1/NAV2 de new_manager, identifier le(s) chemin(s) équivalent(s) dans old_manager :
- `home.account` → `packages/manager/modules/account` + `packages/manager/apps/account`
- `home.billing` → `packages/manager/modules/billing` + `packages/manager/apps/billing`
- `public-cloud.kubernetes` → `packages/manager/apps/pci-kubernetes`
- etc.

Exemple de paires attendues :
- `new_manager.core.tar` ↔ `old_manager.core.tar`
- `new_manager.home.core.tar` ↔ `old_manager.home.core.tar`
- `new_manager.home.billing.tar` ↔ `old_manager.home.billing.tar`
- `new_manager.all.tar` ↔ `old_manager.all.tar`

Si un NAV1/NAV2 existe dans new mais pas dans old :
- Signaler dans l'analyse
- Créer quand même le tar (avec ce qui existe, ou vide)

# Scripts à générer

## Script 1 : `/home/ubuntu/new_generate_manager_tars.sh`
- Travaille dans `/home/ubuntu/aiapp/frontend`
- Supprime UNIQUEMENT `/home/ubuntu/new_manager.*.tar` (jamais old_manager)
- Génère les tars `new_manager.*.tar`

## Script 2 : `/home/ubuntu/old_generate_manager_tars.sh`
- Travaille dans `/home/ubuntu/manager`
- Supprime UNIQUEMENT `/home/ubuntu/old_manager.*.tar` (jamais new_manager)
- Génère les tars `old_manager.*.tar`
- DOIT créer un tar pour CHAQUE NAV1.core et NAV2 présent dans new_manager
- DOIT inclure les exclusions (voir ci-dessous)

**CRITIQUE - Isolation des rm :**
- `new_generate_manager_tars.sh` : `rm -f /home/ubuntu/new_manager.*.tar`
- `old_generate_manager_tars.sh` : `rm -f /home/ubuntu/old_manager.*.tar`
- INTERDIT de faire `rm -f /home/ubuntu/*manager*.tar` ou similaire

# Options tar
- Utiliser `tar -cf` (création simple)
- NE PAS utiliser `-v` (verbose pollue la sortie)
- NE PAS utiliser `2>/dev/null` (masque les erreurs)

# Exclusions OBLIGATOIRES pour old_manager
Chaque commande tar dans `old_generate_manager_tars.sh` DOIT inclure ces exclusions :
```bash
--exclude='node_modules' \
--exclude='.git' \
--exclude='dist' \
--exclude='coverage' \
--exclude='*.lock' \
--exclude='yarn.lock' \
--exclude='package-lock.json' \
--exclude='*.map' \
--exclude='.cache'
```

# Liste des INTERDIT

- Wildcards `*.ts` dans tar (non interprétés)
- Option `-v` dans tar (verbose inutile, pollue la sortie)
- `2>/dev/null` qui masque les erreurs
- Chemins `~/new_manager` ou `~/old_manager` (n'existent pas)
- Utiliser `~` au lieu de `/home/ubuntu`
- Un script qui supprime les tars de l'autre manager
- Oublier les exclusions dans old_manager
- Créer des tars NAV1/NAV2 dans old qui n'existent pas dans new
- Oublier d'inclure les fichiers shared du domaine dans les tars NAV2
- Inclure les sous-dossiers NAV2 dans les tars NAV1.core
- Utiliser underscore `_` après le prefix (DOIT être `.`)
- Format `new_manager_xxx.tar` (INCORRECT, utiliser `new_manager.xxx.tar`)
- Inventer des chemins non vérifiés dans les listes

# Tâches

## 1. Analyse de structure
Depuis les listes fournies :
- Identifier les NAV1 présents dans new_manager (`src/pages/{NAV1}/`)
- Identifier les NAV2 pour chaque NAV1 (`src/pages/{NAV1}/{NAV2}/`)
- Compter les fichiers par domaine
- Classifier par taille : XS (<15), S (15-35), M (35-70), L (70-120), XL (>120)

## 2. Mapping new → old
Pour chaque NAV1 et NAV2 de new_manager :
- Identifier le(s) chemin(s) équivalent(s) dans old_manager
- Vérifier leur existence dans la liste
- Signaler les absences

## 3. Validation des chemins (CRITIQUE)
Pour chaque tar proposé :
- Lister les chemins à inclure
- Vérifier chaque chemin dans la liste fournie (grep)
- Si un chemin n'existe pas → NE PAS l'inclure + signaler

## 4. Tableau récapitulatif
| Tar | Chemins new_manager | Chemins old_manager | Shared inclus | Vérifié |
|-----|---------------------|---------------------|---------------|---------|
| ... | ... | ... | oui/non | ✓/✗ |

## 5. Attendre confirmation
**NE PAS générer les scripts avant mon "GO".**

## 6. Générer les scripts
Après le "GO" :
- Générer les 2 scripts avec cp+tee
- Chaque script dans un bloc markdown séparé
- Facile à copier-coller

# Format de génération (cp+tee)

**Pattern OBLIGATOIRE pour script 1 :**
```
cp /home/ubuntu/new_generate_manager_tars.sh /home/ubuntu/new_generate_manager_tars.sh.$(date +%Y%m%d%H%M%S) 2>/dev/null || true
tee /home/ubuntu/new_generate_manager_tars.sh <<'FS'
#!/bin/bash
set -e
[contenu]
FS
chmod +x /home/ubuntu/new_generate_manager_tars.sh
```

**Pattern OBLIGATOIRE pour script 2 :**
```
cp /home/ubuntu/old_generate_manager_tars.sh /home/ubuntu/old_generate_manager_tars.sh.$(date +%Y%m%d%H%M%S) 2>/dev/null || true
tee /home/ubuntu/old_generate_manager_tars.sh <<'FS'
#!/bin/bash
set -e
[contenu]
FS
chmod +x /home/ubuntu/old_generate_manager_tars.sh
```

**Rappels anti-casse cp+tee :**
- `FS` final en début de ligne, sans espace
- Apostrophes simples `'FS'` (pas de guillemets intelligents)
- Pas d'indentation avant `tee ... <<'FS'` ni avant `FS`
- Toujours `/home/ubuntu`, jamais `~`

# Sortie attendue

1. **Tableau NAV1/NAV2** de new_manager avec comptage fichiers
2. **Tableau mapping** new → old avec vérification existence
3. **Liste des fichiers core** détectés par domaine NAV1
4. **Liste des fichiers shared** détectés par domaine
5. **Signalement** des chemins introuvables
6. **Proposition** de stratégie
7. **Attente du GO**
8. (après GO) **Scripts** avec cp+tee, chacun dans un markdown séparé

# Checklist finale avant scripts

Avant de générer, vérifier :
- [ ] Tous les chemins existent dans les listes fournies
- [ ] Format des noms : `{prefix}.{domaine}.tar` avec POINT (pas underscore)
- [ ] Exclusions présentes pour old_manager
- [ ] Utilisation de dossiers plutôt que fichiers individuels
- [ ] Shared du domaine parent inclus dans les tars NAV2
- [ ] Pas de wildcards dans tar
- [ ] Pas d'option -v
- [ ] Chemins absolus /home/ubuntu (pas ~)
- [ ] Chaque script supprime UNIQUEMENT ses propres tars
